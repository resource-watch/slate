
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Developer Docs - Resource Watch API</title>

    <style media="screen">
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cpf {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s, .highlight .sa, .highlight .dl {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf, .highlight .fm {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv, .highlight .vm {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .nl {
  color: #f92672;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <style media="print">
      * {
        -webkit-transition:none!important;
        transition:none!important;
      }
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #586e75;
}
.highlight .err {
  color: #002b36;
  background-color: #dc322f;
}
.highlight .c, .highlight .ch, .highlight .cd, .highlight .cm, .highlight .cpf, .highlight .c1, .highlight .cs {
  color: #657b83;
}
.highlight .cp {
  color: #b58900;
}
.highlight .nt {
  color: #b58900;
}
.highlight .o, .highlight .ow {
  color: #93a1a1;
}
.highlight .p, .highlight .pi {
  color: #93a1a1;
}
.highlight .gi {
  color: #859900;
}
.highlight .gd {
  color: #dc322f;
}
.highlight .gh {
  color: #268bd2;
  background-color: #002b36;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #6c71c4;
}
.highlight .kc {
  color: #cb4b16;
}
.highlight .kt {
  color: #cb4b16;
}
.highlight .kd {
  color: #cb4b16;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .dl, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #859900;
}
.highlight .sa {
  color: #6c71c4;
}
.highlight .sr {
  color: #2aa198;
}
.highlight .si {
  color: #d33682;
}
.highlight .se {
  color: #d33682;
}
.highlight .nn {
  color: #b58900;
}
.highlight .nc {
  color: #b58900;
}
.highlight .no {
  color: #b58900;
}
.highlight .na {
  color: #268bd2;
}
.highlight .m, .highlight .mb, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mx {
  color: #859900;
}
.highlight .ss {
  color: #859900;
}
    </style>
    <link href="stylesheets/screen-f112f4df.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print-4d023e20.css" rel="stylesheet" media="print" />
      <script src="javascripts/all-510caf58.js"></script>

  </head>

  <body class="developer rw" data-languages="[&quot;shell&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar-cad8cdcb.png" alt="" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo-a42ba9eb.png" class="logo" alt="" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">cURL</a>
        </div>
      <ul class="toc-list-h1">
          <li>
            <a href="index.html" class="toc-h1 toc-link" data-title="Home">Home</a>
          </li>
          <li>
            <a href="quickstart.html" class="toc-h1 toc-link" data-title="Quickstart">Quickstart</a>
          </li>
          <li>
            <a href="concepts.html" class="toc-h1 toc-link" data-title="Concepts">Concepts</a>
          </li>
          <li>
            <a href="reference.html" class="toc-h1 toc-link" data-title="Reference">Reference</a>
          </li>
          <li>
            <a href="tutorials.html" class="toc-h1 toc-link" data-title="Tutorials">Tutorials</a>
          </li>
      </ul>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#who-is-this-for" class="toc-h2 toc-link" data-title="Who is this for?">Who is this for?</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#api-architecture" class="toc-h1 toc-link" data-title="API Architecture">API Architecture</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#microservice-architecture" class="toc-h2 toc-link" data-title="Microservice architecture">Microservice architecture</a>
                  </li>
                  <li>
                    <a href="#microservice-dependency-graphs" class="toc-h2 toc-link" data-title="Microservice dependency graphs">Microservice dependency graphs</a>
                  </li>
                  <li>
                    <a href="#data-layer-dependencies" class="toc-h2 toc-link" data-title="Data layer dependencies">Data layer dependencies</a>
                  </li>
                  <li>
                    <a href="#lifecycle-of-a-request" class="toc-h2 toc-link" data-title="Lifecycle of a request">Lifecycle of a request</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#control-tower" class="toc-h1 toc-link" data-title="Control Tower">Control Tower</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#overview" class="toc-h2 toc-link" data-title="Overview">Overview</a>
                  </li>
                  <li>
                    <a href="#api-proxy-router" class="toc-h2 toc-link" data-title="API proxy/router">API proxy/router</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#handling-a-matching-request" class="toc-h3 toc-link" data-title="Handling a matching request">Handling a matching request</a>
                          </li>
                          <li>
                            <a href="#handling-a-non-matching-request" class="toc-h3 toc-link" data-title="Handling a non-matching request">Handling a non-matching request</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#no-uri-and-method-match" class="toc-h4 toc-link" data-title="No URI and method match">No URI and method match</a>
                                  </li>
                                  <li>
                                    <a href="#authenticated" class="toc-h4 toc-link" data-title="Authenticated">Authenticated</a>
                                  </li>
                                  <li>
                                    <a href="#application-key" class="toc-h4 toc-link" data-title="Application key">Application key</a>
                                  </li>
                                  <li>
                                    <a href="#filter-error" class="toc-h4 toc-link" data-title="Filter error">Filter error</a>
                                  </li>
                              </ul>
                          </li>
                          <li>
                            <a href="#microservice-registration-process" class="toc-h3 toc-link" data-title="Microservice registration process">Microservice registration process</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#overview-2" class="toc-h4 toc-link" data-title="Overview">Overview</a>
                                  </li>
                                  <li>
                                    <a href="#minimal-configuration" class="toc-h4 toc-link" data-title="Minimal configuration">Minimal configuration</a>
                                  </li>
                                  <li>
                                    <a href="#advanced-configuration" class="toc-h4 toc-link" data-title="Advanced configuration">Advanced configuration</a>
                                  </li>
                              </ul>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#management-api" class="toc-h2 toc-link" data-title="Management API">Management API</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#microservice-management-endpoints" class="toc-h3 toc-link" data-title="Microservice management endpoints">Microservice management endpoints</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#get-microservice" class="toc-h4 toc-link" data-title="GET <code>/microservice/</code>">GET <code>/microservice/</code></a>
                                  </li>
                                  <li>
                                    <a href="#get-microservice-status" class="toc-h4 toc-link" data-title="GET <code>/microservice/status</code>">GET <code>/microservice/status</code></a>
                                  </li>
                                  <li>
                                    <a href="#post-microservice" class="toc-h4 toc-link" data-title="POST <code>/microservice/</code>">POST <code>/microservice/</code></a>
                                  </li>
                                  <li>
                                    <a href="#delete-microservice-id" class="toc-h4 toc-link" data-title="DELETE <code>/microservice/:id</code>">DELETE <code>/microservice/:id</code></a>
                                  </li>
                              </ul>
                          </li>
                          <li>
                            <a href="#endpoint-management-endpoints" class="toc-h3 toc-link" data-title="Endpoint management endpoints">Endpoint management endpoints</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#get-endpoint" class="toc-h4 toc-link" data-title="GET <code>/endpoint</code>">GET <code>/endpoint</code></a>
                                  </li>
                                  <li>
                                    <a href="#delete-endpoint-purge-all" class="toc-h4 toc-link" data-title="DELETE <code>/endpoint/purge-all</code>">DELETE <code>/endpoint/purge-all</code></a>
                                  </li>
                              </ul>
                          </li>
                          <li>
                            <a href="#documentation-management-endpoints" class="toc-h3 toc-link" data-title="Documentation management endpoints">Documentation management endpoints</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#get-doc-swagger" class="toc-h4 toc-link" data-title="GET <code>/doc/swagger</code>">GET <code>/doc/swagger</code></a>
                                  </li>
                              </ul>
                          </li>
                          <li>
                            <a href="#plugin-management-endpoints" class="toc-h3 toc-link" data-title="Plugin management endpoints">Plugin management endpoints</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#get-plugin" class="toc-h4 toc-link" data-title="GET <code>/plugin</code>">GET <code>/plugin</code></a>
                                  </li>
                                  <li>
                                    <a href="#patch-plugin-id" class="toc-h4 toc-link" data-title="PATCH <code>/plugin/:id</code>">PATCH <code>/plugin/:id</code></a>
                                  </li>
                              </ul>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#control-tower-plugins" class="toc-h2 toc-link" data-title="Control Tower plugins">Control Tower plugins</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#time-request" class="toc-h3 toc-link" data-title="Time Request">Time Request</a>
                          </li>
                          <li>
                            <a href="#manage-errors" class="toc-h3 toc-link" data-title="Manage errors">Manage errors</a>
                          </li>
                          <li>
                            <a href="#cors" class="toc-h3 toc-link" data-title="CORS">CORS</a>
                          </li>
                          <li>
                            <a href="#invalidate-cache-endpoints" class="toc-h3 toc-link" data-title="Invalidate cache endpoints">Invalidate cache endpoints</a>
                          </li>
                          <li>
                            <a href="#response-formatter" class="toc-h3 toc-link" data-title="Response formatter">Response formatter</a>
                          </li>
                          <li>
                            <a href="#statistics" class="toc-h3 toc-link" data-title="Statistics">Statistics</a>
                          </li>
                          <li>
                            <a href="#mongodb-sessions" class="toc-h3 toc-link" data-title="MongoDB sessions">MongoDB sessions</a>
                          </li>
                          <li>
                            <a href="#oauth-plugin" class="toc-h3 toc-link" data-title="Oauth plugin">Oauth plugin</a>
                          </li>
                          <li>
                            <a href="#redis-cache" class="toc-h3 toc-link" data-title="Redis cache">Redis cache</a>
                          </li>
                          <li>
                            <a href="#application-key-authorization" class="toc-h3 toc-link" data-title="Application key authorization">Application key authorization</a>
                          </li>
                          <li>
                            <a href="#fastly-cache" class="toc-h3 toc-link" data-title="Fastly cache">Fastly cache</a>
                          </li>
                          <li>
                            <a href="#read-only-mode" class="toc-h3 toc-link" data-title="Read-only mode">Read-only mode</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#control-tower-plugin-development" class="toc-h1 toc-link" data-title="Control Tower plugin development">Control Tower plugin development</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#implementing-functionality" class="toc-h2 toc-link" data-title="Implementing functionality">Implementing functionality</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#middleware" class="toc-h3 toc-link" data-title="Middleware">Middleware</a>
                          </li>
                          <li>
                            <a href="#endpoint-creation" class="toc-h3 toc-link" data-title="Endpoint creation">Endpoint creation</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#data-storage" class="toc-h2 toc-link" data-title="Data storage">Data storage</a>
                  </li>
                  <li>
                    <a href="#plugin-bootstrap-and-config" class="toc-h2 toc-link" data-title="Plugin bootstrap and config">Plugin bootstrap and config</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#microservice-development-guide" class="toc-h1 toc-link" data-title="Microservice development guide">Microservice development guide</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#microservice-overview" class="toc-h2 toc-link" data-title="Microservice overview">Microservice overview</a>
                  </li>
                  <li>
                    <a href="#development-lifecycle" class="toc-h2 toc-link" data-title="Development lifecycle">Development lifecycle</a>
                  </li>
                  <li>
                    <a href="#setting-up-a-development-environment" class="toc-h2 toc-link" data-title="Setting up a development environment">Setting up a development environment</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#execution-native-vs-docker" class="toc-h3 toc-link" data-title="Execution - native vs Docker">Execution - native vs Docker</a>
                          </li>
                          <li>
                            <a href="#using-native-execution" class="toc-h3 toc-link" data-title="Using native execution">Using native execution</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#getting-the-code" class="toc-h4 toc-link" data-title="Getting the code">Getting the code</a>
                                  </li>
                                  <li>
                                    <a href="#installing-dependencies" class="toc-h4 toc-link" data-title="Installing dependencies">Installing dependencies</a>
                                  </li>
                                  <li>
                                    <a href="#configuration" class="toc-h4 toc-link" data-title="Configuration">Configuration</a>
                                  </li>
                                  <li>
                                    <a href="#starting-the-microservice" class="toc-h4 toc-link" data-title="Starting the microservice">Starting the microservice</a>
                                  </li>
                                  <li>
                                    <a href="#running-the-tests" class="toc-h4 toc-link" data-title="Running the tests">Running the tests</a>
                                  </li>
                                  <li>
                                    <a href="#common-errors-and-pitfalls" class="toc-h4 toc-link" data-title="Common errors and pitfalls">Common errors and pitfalls</a>
                                  </li>
                              </ul>
                          </li>
                          <li>
                            <a href="#using-docker" class="toc-h3 toc-link" data-title="Using Docker">Using Docker</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#getting-the-code-2" class="toc-h4 toc-link" data-title="Getting the code">Getting the code</a>
                                  </li>
                                  <li>
                                    <a href="#installing-dependencies-2" class="toc-h4 toc-link" data-title="Installing dependencies">Installing dependencies</a>
                                  </li>
                                  <li>
                                    <a href="#configuration-2" class="toc-h4 toc-link" data-title="Configuration">Configuration</a>
                                  </li>
                                  <li>
                                    <a href="#starting-the-microservice-2" class="toc-h4 toc-link" data-title="Starting the microservice">Starting the microservice</a>
                                  </li>
                                  <li>
                                    <a href="#running-the-tests-2" class="toc-h4 toc-link" data-title="Running the tests">Running the tests</a>
                                  </li>
                                  <li>
                                    <a href="#common-errors-and-pitfalls-2" class="toc-h4 toc-link" data-title="Common errors and pitfalls">Common errors and pitfalls</a>
                                  </li>
                              </ul>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#ci-cd" class="toc-h2 toc-link" data-title="CI/CD">CI/CD</a>
                  </li>
                  <li>
                    <a href="#infrastructure-configuration" class="toc-h2 toc-link" data-title="Infrastructure configuration">Infrastructure configuration</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#infrastructure-as-code-using-terraform" class="toc-h3 toc-link" data-title="Infrastructure as code using Terraform">Infrastructure as code using Terraform</a>
                          </li>
                          <li>
                            <a href="#access-to-infrastructure-resources" class="toc-h3 toc-link" data-title="Access to infrastructure resources">Access to infrastructure resources</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#infrastructure-details" class="toc-h4 toc-link" data-title="Infrastructure details">Infrastructure details</a>
                                  </li>
                                  <li>
                                    <a href="#infrastructure-access" class="toc-h4 toc-link" data-title="Infrastructure access">Infrastructure access</a>
                                  </li>
                                  <li>
                                    <a href="#database-access" class="toc-h4 toc-link" data-title="Database access">Database access</a>
                                  </li>
                                  <li>
                                    <a href="#kubernetes-access" class="toc-h4 toc-link" data-title="Kubernetes access">Kubernetes access</a>
                                  </li>
                                  <li>
                                    <a href="#log-access" class="toc-h4 toc-link" data-title="Log access">Log access</a>
                                  </li>
                              </ul>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#testing-your-changes" class="toc-h2 toc-link" data-title="Testing your changes">Testing your changes</a>
                  </li>
                  <li>
                    <a href="#microservice-internal-architecture-nodejs" class="toc-h2 toc-link" data-title="Microservice internal architecture - nodejs">Microservice internal architecture - nodejs</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#anatomy-of-a-nodejs-microservice" class="toc-h3 toc-link" data-title="Anatomy of a (nodejs) microservice">Anatomy of a (nodejs) microservice</a>
                          </li>
                          <li>
                            <a href="#adding-a-new-endpoint" class="toc-h3 toc-link" data-title="Adding a new endpoint">Adding a new endpoint</a>
                          </li>
                          <li>
                            <a href="#register-your-route-in-koa" class="toc-h3 toc-link" data-title="Register your route in koa">Register your route in koa</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#control-tower-integration" class="toc-h2 toc-link" data-title="Control Tower integration">Control Tower integration</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#registering-on-control-tower" class="toc-h3 toc-link" data-title="Registering on Control Tower">Registering on Control Tower</a>
                          </li>
                          <li>
                            <a href="#requests-to-other-microservices" class="toc-h3 toc-link" data-title="Requests to other microservices">Requests to other microservices</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#docker" class="toc-h2 toc-link" data-title="Docker">Docker</a>
                  </li>
                  <li>
                    <a href="#data-layer" class="toc-h2 toc-link" data-title="Data layer">Data layer</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#mongodb-v3-6" class="toc-h3 toc-link" data-title="MongoDB v3.6">MongoDB v3.6</a>
                          </li>
                          <li>
                            <a href="#postgres-v9-6" class="toc-h3 toc-link" data-title="Postgres v9.6">Postgres v9.6</a>
                          </li>
                          <li>
                            <a href="#aws-elasticsearch-service-v7-7" class="toc-h3 toc-link" data-title="AWS Elasticsearch Service v7.7">AWS Elasticsearch Service v7.7</a>
                          </li>
                          <li>
                            <a href="#redis-v5-0" class="toc-h3 toc-link" data-title="Redis v5.0">Redis v5.0</a>
                          </li>
                          <li>
                            <a href="#neo4j-v2-0" class="toc-h3 toc-link" data-title="Neo4J v2.0">Neo4J v2.0</a>
                          </li>
                          <li>
                            <a href="#rabbitmq-v3-7" class="toc-h3 toc-link" data-title="RabbitMQ v3.7">RabbitMQ v3.7</a>
                          </li>
                          <li>
                            <a href="#cloud-services" class="toc-h3 toc-link" data-title="Cloud services">Cloud services</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#http-caching" class="toc-h2 toc-link" data-title="HTTP caching">HTTP caching</a>
                  </li>
                  <li>
                    <a href="#logging" class="toc-h2 toc-link" data-title="Logging">Logging</a>
                  </li>
                  <li>
                    <a href="#testing" class="toc-h2 toc-link" data-title="Testing">Testing</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#writing-end-to-end-tests" class="toc-h3 toc-link" data-title="Writing end-to-end tests">Writing end-to-end tests</a>
                          </li>
                          <li>
                            <a href="#test-coverage-metrics" class="toc-h3 toc-link" data-title="Test coverage metrics">Test coverage metrics</a>
                          </li>
                          <li>
                            <a href="#running-your-tests-using-docker-compose" class="toc-h3 toc-link" data-title="Running your tests using docker compose">Running your tests using docker compose</a>
                          </li>
                          <li>
                            <a href="#ci-cd-travis-and-code-climate" class="toc-h3 toc-link" data-title="CI/CD, Travis and Code Climate">CI/CD, Travis and Code Climate</a>
                          </li>
                          <li>
                            <a href="#smoke-testing" class="toc-h3 toc-link" data-title="Smoke testing">Smoke testing</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deploying-your-microservice" class="toc-h2 toc-link" data-title="Deploying your microservice">Deploying your microservice</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#jenkins" class="toc-h3 toc-link" data-title="Jenkins">Jenkins</a>
                              <ul class="toc-list-h4">
                                  <li>
                                    <a href="#getting-access-to-jenkins" class="toc-h4 toc-link" data-title="Getting access to Jenkins">Getting access to Jenkins</a>
                                  </li>
                              </ul>
                          </li>
                          <li>
                            <a href="#kubernetes-configuration" class="toc-h3 toc-link" data-title="Kubernetes configuration">Kubernetes configuration</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#documentation" class="toc-h2 toc-link" data-title="Documentation">Documentation</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#readme" class="toc-h3 toc-link" data-title="README">README</a>
                          </li>
                          <li>
                            <a href="#functional-documentation" class="toc-h3 toc-link" data-title="Functional documentation">Functional documentation</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#code-styling" class="toc-h2 toc-link" data-title="Code styling">Code styling</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#endpoints" class="toc-h1 toc-link" data-title="Endpoints">Endpoints</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#finding-users-by-ids" class="toc-h2 toc-link" data-title="Finding users by ids">Finding users by ids</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#microservice-reference" class="toc-h1 toc-link" data-title="Microservice reference">Microservice reference</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#core" class="toc-h2 toc-link" data-title="Core">Core</a>
                  </li>
                  <li>
                    <a href="#gfw" class="toc-h2 toc-link" data-title="GFW">GFW</a>
                  </li>
                  <li>
                    <a href="#fw" class="toc-h2 toc-link" data-title="FW">FW</a>
                  </li>
                  <li>
                    <a href="#aqueduct" class="toc-h2 toc-link" data-title="Aqueduct">Aqueduct</a>
                  </li>
                  <li>
                    <a href="#prep" class="toc-h2 toc-link" data-title="PREP">PREP</a>
                  </li>
                  <li>
                    <a href="#climate-watch" class="toc-h2 toc-link" data-title="Climate Watch">Climate Watch</a>
                  </li>
                  <li>
                    <a href="#rw" class="toc-h2 toc-link" data-title="RW">RW</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#api-smoke-tests" class="toc-h1 toc-link" data-title="API Smoke Tests">API Smoke Tests</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#template-for-smoke-tests" class="toc-h2 toc-link" data-title="Template for smoke tests">Template for smoke tests</a>
                  </li>
                  <li>
                    <a href="#things-to-pay-attention" class="toc-h2 toc-link" data-title="Things to pay attention">Things to pay attention</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#use-a-user-to-run-the-tests" class="toc-h3 toc-link" data-title="Use a user to run the tests">Use a user to run the tests</a>
                          </li>
                          <li>
                            <a href="#always-configure-alarms-for-the-smoke-tests" class="toc-h3 toc-link" data-title="Always configure alarms for the smoke tests">Always configure alarms for the smoke tests</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#running-smoke-tests-locally" class="toc-h2 toc-link" data-title="Running smoke tests locally">Running smoke tests locally</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#query-transformations" class="toc-h1 toc-link" data-title="Query transformations">Query transformations</a>
          </li>
          <li>
            <a href="#microservices" class="toc-h1 toc-link" data-title="Microservices">Microservices</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#list-all-registered-microservices" class="toc-h2 toc-link" data-title="List all registered microservices">List all registered microservices</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#filters" class="toc-h3 toc-link" data-title="Filters">Filters</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#get-a-microservice-by-id" class="toc-h2 toc-link" data-title="Get a microservice by id">Get a microservice by id</a>
                  </li>
                  <li>
                    <a href="#delete-microservice" class="toc-h2 toc-link" data-title="Delete microservice">Delete microservice</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#areas-v2-notification-emails" class="toc-h1 toc-link" data-title="Areas v2 Notification Emails">Areas v2 Notification Emails</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#interacting-with-sparkpost-for-building-email-templates" class="toc-h2 toc-link" data-title="Interacting with Sparkpost for building email templates">Interacting with Sparkpost for building email templates</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#subscriptions" class="toc-h1 toc-link" data-title="Subscriptions">Subscriptions</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#creating-a-subscription-for-another-user" class="toc-h2 toc-link" data-title="Creating a subscription for another user">Creating a subscription for another user</a>
                  </li>
                  <li>
                    <a href="#updating-a-subscription-for-another-user" class="toc-h2 toc-link" data-title="Updating a subscription for another user">Updating a subscription for another user</a>
                  </li>
                  <li>
                    <a href="#finding-subscriptions-by-ids" class="toc-h2 toc-link" data-title="Finding subscriptions by ids">Finding subscriptions by ids</a>
                  </li>
                  <li>
                    <a href="#finding-subscriptions-for-a-given-user" class="toc-h2 toc-link" data-title="Finding subscriptions for a given user">Finding subscriptions for a given user</a>
                  </li>
                  <li>
                    <a href="#finding-all-subscriptions" class="toc-h2 toc-link" data-title="Finding all subscriptions">Finding all subscriptions</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#user-management" class="toc-h1 toc-link" data-title="User Management">User Management</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#finding-users-by-ids" class="toc-h2 toc-link" data-title="Finding users by ids">Finding users by ids</a>
                  </li>
                  <li>
                    <a href="#finding-user-ids-by-role" class="toc-h2 toc-link" data-title="Finding user ids by role">Finding user ids by role</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#graph" class="toc-h1 toc-link" data-title="Graph">Graph</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#creating-dataset-graph-nodes" class="toc-h2 toc-link" data-title="Creating dataset graph nodes">Creating dataset graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-creating-dataset-graph-nodes" class="toc-h3 toc-link" data-title="Errors for creating dataset graph nodes">Errors for creating dataset graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#creating-widget-graph-nodes" class="toc-h2 toc-link" data-title="Creating widget graph nodes">Creating widget graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-creating-widget-graph-nodes" class="toc-h3 toc-link" data-title="Errors for creating widget graph nodes">Errors for creating widget graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#creating-layer-graph-nodes" class="toc-h2 toc-link" data-title="Creating layer graph nodes">Creating layer graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-creating-layer-graph-nodes" class="toc-h3 toc-link" data-title="Errors for creating layer graph nodes">Errors for creating layer graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#creating-metadata-graph-nodes" class="toc-h2 toc-link" data-title="Creating metadata graph nodes">Creating metadata graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-creating-metadata-graph-nodes" class="toc-h3 toc-link" data-title="Errors for creating metadata graph nodes">Errors for creating metadata graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deleting-dataset-graph-nodes" class="toc-h2 toc-link" data-title="Deleting dataset graph nodes">Deleting dataset graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-deleting-dataset-graph-nodes" class="toc-h3 toc-link" data-title="Errors for deleting dataset graph nodes">Errors for deleting dataset graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deleting-widget-graph-nodes" class="toc-h2 toc-link" data-title="Deleting widget graph nodes">Deleting widget graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-deleting-widget-graph-nodes" class="toc-h3 toc-link" data-title="Errors for deleting widget graph nodes">Errors for deleting widget graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deleting-layer-graph-nodes" class="toc-h2 toc-link" data-title="Deleting layer graph nodes">Deleting layer graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-deleting-layer-graph-nodes" class="toc-h3 toc-link" data-title="Errors for deleting layer graph nodes">Errors for deleting layer graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deleting-metadata-graph-nodes" class="toc-h2 toc-link" data-title="Deleting metadata graph nodes">Deleting metadata graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-deleting-metadata-graph-nodes" class="toc-h3 toc-link" data-title="Errors for deleting metadata graph nodes">Errors for deleting metadata graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#associating-concepts-to-graph-nodes" class="toc-h2 toc-link" data-title="Associating concepts to graph nodes">Associating concepts to graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-associating-concepts-with-graph-nodes" class="toc-h3 toc-link" data-title="Errors for associating concepts with graph nodes">Errors for associating concepts with graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#updating-concepts-associated-with-graph-nodes" class="toc-h2 toc-link" data-title="Updating concepts associated with graph nodes">Updating concepts associated with graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-associating-concepts-with-graph-nodes-2" class="toc-h3 toc-link" data-title="Errors for associating concepts with graph nodes">Errors for associating concepts with graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deleting-concepts-associated-with-graph-nodes" class="toc-h2 toc-link" data-title="Deleting concepts associated with graph nodes">Deleting concepts associated with graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#query-parameters" class="toc-h3 toc-link" data-title="Query parameters">Query parameters</a>
                          </li>
                          <li>
                            <a href="#errors-for-associating-concepts-with-graph-nodes-3" class="toc-h3 toc-link" data-title="Errors for associating concepts with graph nodes">Errors for associating concepts with graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#creating-favorite-relationships-between-users-and-graph-nodes" class="toc-h2 toc-link" data-title="Creating favorite relationships between users and graph nodes">Creating favorite relationships between users and graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#errors-for-associating-concepts-with-graph-nodes-4" class="toc-h3 toc-link" data-title="Errors for associating concepts with graph nodes">Errors for associating concepts with graph nodes</a>
                          </li>
                      </ul>
                  </li>
                  <li>
                    <a href="#deleting-favorite-relationships-between-users-and-graph-nodes" class="toc-h2 toc-link" data-title="Deleting favorite relationships between users and graph nodes">Deleting favorite relationships between users and graph nodes</a>
                      <ul class="toc-list-h3">
                          <li>
                            <a href="#query-parameters-2" class="toc-h3 toc-link" data-title="Query parameters">Query parameters</a>
                          </li>
                          <li>
                            <a href="#errors-for-associating-concepts-with-graph-nodes-5" class="toc-h3 toc-link" data-title="Errors for associating concepts with graph nodes">Errors for associating concepts with graph nodes</a>
                          </li>
                      </ul>
                  </li>
              </ul>
          </li>
      </ul>
        <ul class="toc-footer">
            <li><a href='quickstart.html'>Getting started</a></li>
            <li><a href='https://github.com/resource-watch/doc-api'>Contribute to these docs</a></li>
            <li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <aside class="notice">
  All use of the Resource Watch API is governed by the Resource Watch <a href="https://resourcewatch.org/terms-of-service" target="_blank">Terms of Service</a> and <a href="https://resourcewatch.org/api-attribution-requirements" target="_blank">API Attribution Requirements</a>.
</aside>
<h1 id='introduction'>Introduction</h1>
<p>Welcome to the Resource Watch API Developer Documentation. </p>
<h2 id='who-is-this-for'>Who is this for?</h2>
<p>This section covers the behind-the-scenes details of the RW API, that are relevant for developers trying to build their own RW API microservice. If you are looking for instructions on how to use the RW API to power your applications, the <a href="./">RW API Documentation</a> is probably what you are looking for.</p>

<p>The developer documentation is aimed at software developers that are familiar with the RW API from a user perspective, and want to extend or modify the functionality of the API. From a technical point of view, this section assumes you are familiar with some technologies, protocols and patterns that are used on the RW API, such as:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP and HTTPS</a></li>
<li><a href="https://en.wikipedia.org/wiki/Microservices">Microservices architecture</a></li>
<li><a href="https://www.docker.com/">Docker</a></li>
<li><a href="https://kubernetes.io/">Kubernetes</a></li>
</ul>

<p>This guide also assumes you are comfortable with programming in general. To keep these docs simple, and as most of the RW API source code is written in <a href="https://nodejs.org/en/">nodejs</a>, that is the language we&#39;ll use for examples or when presenting specific tools and libraries. However, while we recommend using Nodejs, you may use different tools and/or languages when developing your microservices.  </p>

<p>If any of these concepts are new or unfamiliar, we suggest using your favourite search engine to learn more about them before proceeding.</p>
<h1 id='api-architecture'>API Architecture</h1>
<p>This chapter covers the basic architectural details of the API. If you are new to RW API development, you should start here, as key concepts explained here will be needed as you go more hands-on with the API code and/or infrastructure.</p>
<h2 id='microservice-architecture'>Microservice architecture</h2>
<p>The RW API is built using a <a href="https://en.wikipedia.org/wiki/Microservices">microservices architecture</a> using <a href="https://github.com/control-tower/control-tower">Control Tower</a> as the gateway application.</p>

<p>In this configuration, Control Tower (CT) offers gateway and core functionality, like routing or user management, while user-facing functionality is provided by a set of microservices that communicate with each other and the external world through Control Tower.</p>

<p>Internal communication between CT and the microservices is done through HTTP requests, and as such each microservice is built on top of a web server..These different web servers create a network within the API itself, to which will refer throughout the rest of the documentation when we mention &quot;internal network&quot; or &quot;internal requests&quot;. By opposition, an &quot;external request&quot; will reference a request from/to the world wide web, and &quot;external network&quot; basically means &quot;the internet&quot;.</p>

<p>Control Tower itself acts both as an API in itself - with endpoints for management and monitoring - as well as a catch-all side, that is used to proxy requests to the functional endpoints.</p>
<h2 id='microservice-dependency-graphs'>Microservice dependency graphs</h2>
<p><img src="https://raw.githubusercontent.com/gfw-api/wri-api-dependencies/master/graphs/dependencies_graph.png" alt="Microservice dependency graph" /></p>

<p>The graph above illustrates the dependencies between different microservices as of July 2020. Most dependencies are based on endpoint calls: an arrow pointing from <code>query</code> to <code>dataset</code> means that the <code>query</code> microservice makes a call to one of the endpoints implemented by the <code>dataset</code> microservice. The exception to this rule are <code>doc-orchestrator</code>,  <code>doc-executor</code> and  <code>doc-writer</code>, who instead depend on each other via <a href="https://www.rabbitmq.com/">RabbitMQ</a> messages.</p>

<p><img src="https://raw.githubusercontent.com/gfw-api/wri-api-dependencies/master/graphs/no_dependencies_graph.png" alt="Microservice with no dependencies" /></p>

<p>The microservices above do not depend on any of the other microservices.</p>

<p>It&#39;s worth noting that most microservices depend on Control Tower and functionality implicitly offered by it - for example, Control Tower will automatically pass to the microservice the details of the user, should the original HTTP request come with a valid JSON Web Token.</p>
<h2 id='data-layer-dependencies'>Data layer dependencies</h2>
<p><img src="https://raw.githubusercontent.com/gfw-api/wri-api-dependencies/master/graphs/storage_graph.png" alt="Data layer dependencies" /></p>

<p>The graph above illustrates the different data layer elements present on the RW API, and the microservices or sites that depend on each of these.</p>
<h2 id='lifecycle-of-a-request'>Lifecycle of a request</h2>
<p>All incoming requests to the API are handled by CT that, among other things, does the following:
- Checks if there&#39;s a microservice capable of handling that request.
- Checks if authentication data is required and/or is present.
- Automatically filters out anonymous requests to authenticated endpoints.</p>

<p>We&#39;ll go into more details about these processes in the next sections</p>

<p>Control Tower matches each incoming external request to a microservice, by comparing its URI and request method. It then generates a new HTTP request to that microservice and will wait for a response to it - which is used as a response to the original external request.</p>

<p>Microservices can make requests to each other via Control Tower. They also have unrestricted access to the public internet, so 3rd party services can be accessed as they normally would be. The API infrastructure also has other resources, like databases (MongoDB, ElasticSearch, Postgres) or publish-subscribe queues (RabbitMQ), which can be accessed. We&#39;ll cover those in more details in a separate section.</p>
<h1 id='control-tower'>Control Tower</h1>
<p>This chapter covers Control Tower in depth - what it does and how it does it.</p>
<h2 id='overview'>Overview</h2>
<p><a href="https://github.com/control-tower/control-tower">Control Tower</a> is essentially a mix of 3 main concepts:
- An API proxy/router
- A lightweight management API
- A plugin system to extend functionality and its own API.</p>

<p>We&#39;ll cover those 3 topics individually in this section.</p>
<h2 id='api-proxy-router'>API proxy/router</h2>
<p>Control Tower&#39;s most basic functionality is accepting external requests to the API, &quot;forwarding&quot; them to the corresponding microservices, and returning whatever response the microservices produce.</p>

<p>Once an external request is received, Control Tower uses the HTTP request method and the URI of the request to match it to one of the known endpoints exposed internally by one of the microservices. Note that all external requests are handled exclusively by Control Tower, and microservices are no able to directly receive requests from outside the API&#39;s internal network (they can, however, make external requests).</p>

<p>This matching process can have one of two results:</p>
<h3 id='handling-a-matching-request'>Handling a matching request</h3>
<p>Should a match be found for the external request&#39;s URI and method, a new, internal request is generated and dispatched to the corresponding microservice. The original external request will be blocked until the microservice replies to the internal request - and the internal request&#39;s reply will be used as the reply to the external request as soon as the corresponding microservice returns it.</p>

<aside class="notice">
By default, Control Tower does as little changes as necessary to the incoming external request and to the associated response produced by the microservice. However, for security, authentication/authorization, or due to external-to-internal endpoint mapping, changes will be made to requests and replies body, headers, etc.
</aside>
<h3 id='handling-a-non-matching-request'>Handling a non-matching request</h3><h4 id='no-uri-and-method-match'>No URI and method match</h4>
<p>At its most basic, the external requests is matched by URI and HTTP method. Should no combination of URI and method be found, Control Tower will reply to the external request with a <code>404</code> HTTP code.</p>
<h4 id='authenticated'>Authenticated</h4>
<p>Microservice endpoints can be marked as requiring authentication. If a matching request is received, but no user authentication data is provided in the request, Control Tower will reject the request with a <code>401</code> HTTP code.</p>
<h4 id='application-key'>Application key</h4>
<p>Similar to what happens with authenticated endpoints, microservice endpoints can also request an <code>application</code> to be provided in the request. If that requirement is not fulfilled, Control Tower will reject the request with a <code>401</code> HTTP code.</p>
<h4 id='filter-error'>Filter error</h4>
<p>Registered endpoints also have the possibility to specify <code>filters</code> - a custom requirement that must be met by the request in order for a request match to be successful. For example, endpoints associated with dataset operations use a common URI and HTTP method, but will be handled by different microservices depending on the type of dataset being used - this type of functionality can be implemented using the <code>filter</code> functionality. On some scenarios, even if all the previous conditions are met, <code>filters</code> may rule out a given match, in which case a <code>401</code> HTTP code will be returned.</p>
<h3 id='microservice-registration-process'>Microservice registration process</h3>
<p>The matching process described above is carried out by Control Tower based on endpoints declared by each microservice. In this section, we&#39;ll take a detailed look at the process through which microservices can declare their available endpoints to Control Tower</p>
<h4 id='overview-2'>Overview</h4>
<p>Here&#39;s a graphical overview of the requests exchanged between CT and a microservice:</p>

<table><thead>
<tr>
<th>Control Tower</th>
<th style="text-align: center">Request</th>
<th style="text-align: right">Microservice</th>
</tr>
</thead><tbody>
<tr>
<td></td>
<td style="text-align: center">&lt;===   POST /v1/microservice  &lt;===</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">{&quot;name&quot;:&quot;microservice name&quot;, &quot;url&quot;: &quot;http://microservice-url.com&quot;, &quot;active&quot;: true }</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">===&gt;   Reply  ===&gt;</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">HTTP OK</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">===&gt;   GET /api/info  ===&gt;</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">&lt;===   Reply  &lt;===</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">{ /* JSON with microservice details */ }</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">(every 30 seconds)</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">===&gt;   GET /api/ping  ===&gt;</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">&lt;===   Reply  &lt;===</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">pong</td>
<td style="text-align: right"></td>
</tr>
</tbody></table>

<p>The registration process is started by the microservice. It announces its name, internal URL and active state to Control Tower. This tentatively registers the microservice in Control Tower&#39;s database, and triggers the next step of the process.</p>

<p>Immediately after receiving the initial request from the microservice, Control Tower uses the provided URL to reach the microservice. This is used not only to load the endpoint data, but also to ensure that Control Tower is able to reach the microservice at the provided URL - if that does not happen, the registration process is aborted on Control Tower&#39;s side, and the microservice data dropped. When it receives this request, the microservice should reply with a JSON array of supported endpoints. We&#39;ll dive deeper into the structure of that reply in a moment.</p>

<p>The last step of the process is Control Tower processing that JSON entity, and storing its data in its database. From this point on, the microservice is registered and is able to receive user requests through Control Tower.</p>

<p>Control Tower will, every 30 seconds, emit a <code>ping</code> request to the microservice, which must reply to it to confirm to Control Tower that it&#39;s still functional. Should the microservice fail to reply to a ping request, Control Tower will assume its failure, and de-register the microservice and associated endpoints. Should this happen, it&#39;s up to the microservice to re-register itself on Control Tower, to be able to continue accepting requests.</p>
<h4 id='minimal-configuration'>Minimal configuration</h4>
<p>During the registration process, each microservice is responsible for informing Control Tower of the endpoints it supports, if they require authentication, application info, etc. This is done through a JSON object, that has the following basic structure:</p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"dataset"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>Breaking it down bit by bit:</p>

<ul>
<li><code>name</code>: Name of the microservice.</li>
<li><code>tags</code>: List of tags associated with the microservice.</li>
<li><code>endpoints</code>: Array of <code>endpoint</code> objects.</li>
<li><code>swagger</code>: <a href="https://swagger.io/">Swagger</a> formatted JSON object documenting the microservice&#39;s endpoints.</li>
</ul>

<p>Within the <code>endpoints</code> array, the expected object structure is the following: </p>

<ul>
<li><code>path</code>: Expected external request URI that will match to this endpoint.</li>
<li><code>method</code>: Expected external request method that will match to this endpoint.</li>
<li><code>redirect.method</code>: Method to use in the internal request to the microservice.</li>
<li><code>redirect.path</code>: URI to use in the internal request to the microservice.</li>
</ul>

<p>Taking the example above, that reply would be provided by the <code>dataset</code> microservice while registering on Control Tower. It would tell CT that it has a single public endpoint, available at GET <code>&lt;api public URL&gt;/v1/dataset</code>. When receiving that external request, the <code>redirect</code> portion of the endpoint configuration tells CT to issue a GET request to <code>&lt;microservice URL&gt;/api/v1/dataset</code>. It then follows the process previously described to handle the reply from the microservice and return its content to the user.</p>
<h4 id='advanced-configuration'>Advanced configuration</h4>
<p>The example from the previous section covers the bare minimum a microservice needs to provide to Control Tower in order to register an endpoint. However, as discussed before, Control Tower can also provide support for more advanced features, like authentication and application data filtering. The JSON <code>endpoint</code> snippet below shows how these optional parameters can be used to configure said functionality. </p>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query-document"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"query-document"</span><span class="p">],</span><span class="w">
    </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/query/:dataset"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"binary"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"authenticated"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"applicationRequired"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/document/query/:dataset"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"dataset"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"compare"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"connectorType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}]</span><span class="w">
        </span><span class="p">}</span><span class="w">   
    </span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>Within the <code>endpoints</code> array, you&#39;ll notice a few changes. The <code>path</code> property now includes an URI which contains <code>:dataset</code> in it - this notation tells Control Tower to expect a random value in that part of the URI (delimited by <code>/</code>) and to refer to that value as <code>dataset</code> in other parts of the process.</p>

<p>The <code>redirect.path</code> references the same <code>:dataset</code> value - meaning the incoming value from the external request will be passed on to the internal requests to the microservice generated by Control Tower.</p>

<p>You&#39;ll also notice new fields that were not present before: </p>

<ul>
<li><code>binary</code>: Using this causes Control Tower to pipe the microservice&#39;s response content as a binary stream to the external request&#39;s reply. Use this in case you expect your microservice&#39;s replies to have large amounts of binary data - for example, a file for download.</li>
<li><code>authenticated</code>: Setting this to <code>true</code> causes Control Tower to immediately return an HTTP <code>401</code> error code in case this endpoint matches the external request, but that request has no user identification data.</li>
<li><code>applicationRequired</code>: Setting this to <code>true</code> causes Control Tower to immediately return an HTTP <code>401</code> error code in case this endpoint matches the external request, but that request has no application data as part of the user&#39;s data.</li>
<li><code>filters</code>: An array of filter objects that the request must match to in order for a match to be considered successful.</li>
<li><code>filters.name</code>: A name for the filter, without functional implications.</li>
<li><code>filters.method</code>: Method to use in the filter request.</li>
<li><code>filters.path</code>: URI to use in the filter request.</li>
<li><code>filters.params</code>: Query parameters passed to the filter request.</li>
<li><code>filters.compare</code>: Response structure to be matched with the filter request reply, to determine if the external request matches this filter.</li>
</ul>

<p>The filtering section has the most complex structure, so lets analyse it with a real-world example. The above example would match a request like GET <code>&lt;api external URL&gt;/v1/query/&lt;dataset id&gt;</code>. Once that request is received by Control Tower, it is tentatively matched to this endpoint, but pending the validation of the filter section.</p>

<p>To process the filter, Control Tower will do a request of type <code>filters.method</code> (GET, in this case) and URI <code>filters.path</code>. As the URI contains a <code>:dataset</code> variable, it will use the <code>filters.params</code> object to map that value to the <code>dataset</code> value from the external request. This internal request is then issued and the process briefly stopped until a response is returned.</p>

<p>Once the response is returned, the <code>filters.compare</code> object comes into play: Control Tower will see if the response body object matches the set value in the <code>filters.compare</code> object. In this particular example, the resulting comparison would be something like <code>response.body.data.attributes.connectorType == &quot;document&quot;</code>. Should this evaluate to <code>true</code>, the filter is considered to have matched, and this endpoint is used to dispatch the internal request to. Otherwise, this endpoint is discarded from the list of possible matches for this external request.</p>

<p>The data loaded as part of the filtering process is then passed on to the microservice that will handle that call, either as query arguments (DELETE or GET requests) or as part of the body (PATCH, POST and PUT requests). The query param/body property is named after the <code>filter.name</code> value configured in the filter. In our example, the request issued to the microservice that matches the filter would be of type POST, so its body will contain a <code>dataset</code> property containing the response from querying the filter endpoint - <code>/v1/dataset/:dataset</code>. <aside class="notice">Automatically passing filter data in the request generated to the microservice is now deprecated, and all microservices should instead load the necessary data by calling the respective microservices themselves.</aside> </p>

<p>Its worth noting at this stage that there&#39;s no restriction regarding uniqueness of internal endpoints - two microservices may support the same endpoint, and use filters to differentiate between them based on the underlying data. The example above illustrates how a microservice can support the <code>/v1/query/:dataset</code> external endpoint, but only for datasets of type <code>document</code>. A different microservice may support the same endpoint, but with a different filter value (for example <code>carto</code>) and offer the same external functionality with a completely different underlying implementation.</p>

<p>Should multiple endpoints match an external request, one of them is chosen and used - there are no guarantees in terms of which is picked, so while this scenario does not produce an error, you probably want to avoid it.</p>
<h2 id='management-api'>Management API</h2>
<p>In the previous section, we discussed how microservices can register their endpoint on Control Tower, exposing their functionality to the outside world. That registration process uses part of Control Tower&#39;s own API, which we&#39;ll discuss in finer detail in this section.</p>
<h3 id='microservice-management-endpoints'>Microservice management endpoints</h3>
<p>The microservice registration endpoint is one of 4 endpoints that exist around microservice management:</p>
<h4 id='get-microservice'>GET <code>/microservice/</code></h4>
<p>This endpoint shows a list of registered microservice and their corresponding endpoints.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/microservice <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="nl">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-05T07:33:30.244Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"dataset"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5aa66766aee7ae846a419c0c"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://dataset.default.svc.cluster.local:3000"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-23T14:27:10.957Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div><h4 id='get-microservice-status'>GET <code>/microservice/status</code></h4>
<p>Lists information about operational status of each microservice - like errors detected by Control Tower trying to contact the microservice or number of retries attempted.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/microservice/status <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="nl">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-05T07:36:30.199Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div><h4 id='post-microservice'>POST <code>/microservice/</code></h4>
<p>This is the endpoint used by microservices to register on Control Tower. You can find a detailed analysis of its syntax in the <a href="developer.html#api-proxy-router">previous section</a></p>
<h4 id='delete-microservice-id'>DELETE <code>/microservice/:id</code></h4>
<p>This endpoint is used to unregister a microservice&#39;s endpoints from Control Tower. Control Tower does not actually delete the microservice information, nor does it immediately remove the endpoints associated to it. This endpoint iterates over all endpoint associated with the microservice to be unregistered, and flags them for deletion - which is actually done by a cron task that in the background. Until that moment, the microservice and associated endpoints will continue to be available, and external requests to those endpoints will be handled as matched as they were before. However, you will notice that endpoints scheduled for deletion will have a <code>toDelete</code> value of true - more on this in the next section.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/microservice/&lt;microservice <span class="nb">id</span><span class="o">&gt;</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c0782831b0bf92a37a754e2"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:3001"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-05T07:49:36.754Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h3 id='endpoint-management-endpoints'>Endpoint management endpoints</h3><h4 id='get-endpoint'>GET <code>/endpoint</code></h4>
<p>This endpoint lists all microservice endpoint known by Control Tower. Note that it does not contain endpoints offered by Control Tower itself or any of its plugins.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/endpoint <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"pathKeys"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"authenticated"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"applicationRequired"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"binary"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"toDelete"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c0784c88dcce0323abe705d"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"pathRegex"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
        </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
                </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c0784c88dcce0323abe705e"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:3001"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div><h4 id='delete-endpoint-purge-all'>DELETE <code>/endpoint/purge-all</code></h4>
<p>This endpoint purges the complete HTTP cache for all microservices. It does not support any kind of parametrization, so it&#39;s not possible to use this endpoint to clear only parts of the cache. As such, we recommend not using this endpoint unless you are certain of its consequences, as it will have noticeable impact in end-user perceived performance.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/endpoint/purge-all <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><h3 id='documentation-management-endpoints'>Documentation management endpoints</h3><h4 id='get-doc-swagger'>GET <code>/doc/swagger</code></h4>
<p>Generates a complete <a href="https://swagger.io/">Swagger</a> JSON file documenting all API endpoints. This swagger is compiled by Control Tower based on Swagger files provided by each microservice. As such, the Swagger details for a given endpoint will only be as good as the information provided by the microservice itself.</p>

<aside class="notice">
This
</aside>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/endpoint <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Control Tower"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Control Tower - API"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tower.dev:9000"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"schemes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"http"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"application/vnd.api+json"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"application/json"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"/api/v1/doc/swagger"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Return swagger files of registered microservices"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"getSwagger"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"ControlTower"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"application/vnd.api+json"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Swagger json"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="nl">"500"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Unexpected error"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/Errors"</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"Errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Errors"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/Error"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"Error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"int32"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A unique identifier for this particular occurrence of the problem."</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A links object"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"about"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A link that leads to further details about this particular occurrence of the problem."</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The HTTP status code applicable to this problem, expressed as a string value"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An application-specific error code, expressed as a string value"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A short, human-readable summary of the problem that SHOULD NOT change from occurrence to occurrence of the problem, except for purposes of localization."</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"detail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A human-readable explanation specific to this occurrence of the problem. Like title, this field's value can be localized"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An object containing references to the source of the error, optionally including any of the following members"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"pointer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A JSON Pointer [RFC6901] to the associated entity in the request document"</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="nl">"parameter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                            </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A string indicating which URI query parameter caused the error."</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A meta object containing non-standard meta-information about the error."</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h3 id='plugin-management-endpoints'>Plugin management endpoints</h3>
<p>Control Tower as a plugin system of its own, which we&#39;ll cover in detail in the next section. As part of that system it has a few API endpoints to support certain actions</p>
<h4 id='get-plugin'>GET <code>/plugin</code></h4>
<p>Lists all currently enabled plugins, along with their configuration.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/plugin <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5bfd440834d5076bb4609f9f"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"manageErrors"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Manage Errors"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"mainFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"plugins/manageErrors"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"jsonAPIErrors"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div><h4 id='patch-plugin-id'>PATCH <code>/plugin/:id</code></h4>
<p>Updates the settings of a given plugin.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> PATCH <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/plugin/:pluginId <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  <span class="nt">-d</span> <span class="s1">'{
    "config": {
        "jsonAPIErrors": false
    }
}'</span>
</code></pre></div><div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5bfd440834d5076bb4609f9f"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"manageErrors"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Manage Errors"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"mainFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"plugins/manageErrors"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"jsonAPIErrors"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h2 id='control-tower-plugins'>Control Tower plugins</h2>
<p>Control Tower provides basic API management functionality, but it also has a set of plugins that allow decoupling non-core functionality from the core code base. In this section we&#39;ll briefly cover the functional aspect of each plugin, without focusing too much on the underlying implementation, which will be covered separately.</p>
<h3 id='time-request'>Time Request</h3>
<p>This plugin times the time elapsed between the external request is received and the reply to it being dispatched back to the external API client. It adds the computed value as a response header <code>X-Response-Time</code></p>
<h3 id='manage-errors'>Manage errors</h3>
<p>This plugin intercepts replies that represent errors and formats them properly.</p>
<h3 id='cors'>CORS</h3>
<p>This plugins adds the necessary headers to support <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a></p>
<h3 id='invalidate-cache-endpoints'>Invalidate cache endpoints</h3>
<p>Varnish cache integration plugin that invalidates cache entries.</p>

<aside class="notice">
This plugin is disabled and is no longer supported.
</aside>
<h3 id='response-formatter'>Response formatter</h3>
<p>Handles response formats other than the default JSON, setting headers and formatting the response body according to the requested content type. Currently only supports XML.</p>
<h3 id='statistics'>Statistics</h3>
<p>Collects and stores statistics about the API usage.</p>
<h3 id='mongodb-sessions'>MongoDB sessions</h3>
<p>Adds support for storing session data on MongoDB</p>
<h3 id='oauth-plugin'>Oauth plugin</h3>
<p>User management and authentication plugin. Supports email+password based registration, as well as Facebook, Twitter, Apple and Google oauth-based authentication.</p>
<h3 id='redis-cache'>Redis cache</h3>
<p>Redis-based caching for Control Tower. </p>

<aside class="notice">
This plugin is disabled and is no longer supported.
</aside>
<h3 id='application-key-authorization'>Application key authorization</h3>
<p>Application key handling.</p>
<h3 id='fastly-cache'>Fastly cache</h3>
<p>Integrates HTTP caching using <a href="https://www.fastly.com/">Fastly</a>.</p>
<h3 id='read-only-mode'>Read-only mode</h3>
<blockquote>
<p>Rejected endpoints will have HTTP status 503 and the following message:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="s2">"API under maintenance, please try again later."</span><span class="w">
</span></code></pre></div>
<blockquote>
<p>Configuration of white and black lists:</p>
</blockquote>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="p">{</span>
    <span class="c1">// This blacklist prevents GETting widgets</span>
    <span class="dl">"</span><span class="s2">blacklist</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">/api/v1/widget</span><span class="dl">"</span><span class="p">],</span>

    <span class="c1">// This whitelist allows POST/PATCH/DELETE calls for datasets and layers</span>
    <span class="dl">"</span><span class="s2">whitelist</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">/api/v1/dataset</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">/api/v1/layer</span><span class="dl">"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
<p>This plugin activates a <strong>read-only mode</strong> that passes through all calls to GET endpoints and rejects calls to POST/PATCH/PUT/DELETE endpoints. The plugin provides the following configurations for increased flexibility:</p>

<ul>
<li><code>whitelist</code>: An array of POST/PATCH/PUT/DELETE endpoints that should be passed through. Each item of the array should be a string matching exactly the path to whitelist.</li>
<li><code>blacklist</code>: An array of GET endpoints that should be rejected. Each item of the array should be a string matching exactly the path to blacklist.</li>
</ul>

<p><strong>Note: Please ensure you know what you&#39;re doing when activating this plugin, since it will highly restrict the usage of the API.</strong></p>
<h1 id='control-tower-plugin-development'>Control Tower plugin development</h1>
<p>This chapter covers Control Tower plugin development basics. It aims at providing basic understanding of how existing Control Tower plugins work, and give you the foundations to develop your own plugins.</p>
<h2 id='implementing-functionality'>Implementing functionality</h2>
<p>Control Tower and its plugins are implemented using Nodejs and <a href="https://koajs.com/">Koa</a>. Be sure to familiarize yourself with the key concepts behind this framework before exploring this section, as it assumes you are comfortable with concepts like route declaration or koa middleware.</p>

<p>Existing plugin functionality for Control Tower falls within one of two categories: middleware that intercepts requests as they are processed by Control Tower, or new endpoints that are added to Control Tower&#39;s API. Some plugins combine the two approaches to implement their functionality.</p>
<h3 id='middleware'>Middleware</h3>
<p>Middleware-based functionality consists of intercepting the external request and/or response and either gathering data about them (for logging or statistics) or modifying them (for example, for caching). This type of functionality can be implemented using koa&#39;s middleware API, as Control Tower itself does not modify or extend that in any way.</p>
<h3 id='endpoint-creation'>Endpoint creation</h3>
<p>Plugins can also extend Control Tower&#39;s endpoint list by registering new endpoints of their own. An example of this is the Control Tower Oauth plugin that exposes a number of endpoints to support actions like registering, logging in, recovering password, etc. Like with the middleware approach, this can be implemented by relying on koa principles, and Control Tower does not modify this behavior.</p>
<h2 id='data-storage'>Data storage</h2>
<p>Control Tower uses a Mongo database to store data like known microservices or endpoints. Plugins can also access this database and create their own collections, should they wish to. Control Tower and existing plugins rely on <a href="https://mongoosejs.com/">Mongoose</a> to that effect, and you&#39;ll find example of its usage throughout Control Tower and its plugins code.</p>
<h2 id='plugin-bootstrap-and-config'>Plugin bootstrap and config</h2>
<p>During its first initialization, Control Tower will load plugin settings from <a href="https://github.com/control-tower/control-tower/blob/develop/app/src/migrations/init.js">this file</a>. It includes a list of plugins to be initialized, whether or not they should be active, and their default configuration. On subsequent executions, this information will be loaded from the database instead, so additional changes you may want to do should be done on the database, and not on this file.</p>

<p>An important part of this file and of the corresponding database entries is plugin configuration. This data is stored within the <code>plugins</code> MongoDB collection managed by Control Tower but it&#39;s made available to plugins as they are initialized and ran.</p>
<h1 id='microservice-development-guide'>Microservice development guide</h1>
<p>In this chapter, we&#39;ll cover additional details that you, as a RW API developer, should keep in mind when developing your microservice. We&#39;ll focus not only on the technical requirements you need to meet for your microservice to communicate with the remaining RW API internal components, but also discuss the policy surrounding development for the RW API, as a way to achieve a certain degree of consistency across a naturally heterogeneous microservice-based system.</p>

<aside class="notice">
Control Tower, which is mentioned throughout these docs, will be replaced soon with an equivalent but alternative solution. While we will aim to have this transition be as seamless as possible, you may need to adapt your code once this is done.
</aside>
<h2 id='microservice-overview'>Microservice overview</h2>
<p>As described in the <a href="developer.html#api-architecture">API Architecture</a> section, microservices are small web applications that expose a REST API through a web server. This means that microservices can be built using any programming language, just as long as it supports HTTP communication. In practical terms, most of this API&#39;s core microservices are built using <a href="https://nodejs.org">nodejs</a>, with <a href="https://www.python.org/">Python</a> and <a href="https://rubyonrails.org/">Rails</a> being distant 2nd and 3rd respectively. New microservices being developed should respect this hierarchy when it comes to choosing a development language, and the adoption of a different stack should be validated with the remaining development team members beforehand.</p>

<p>In this whole section, we will use code examples from the <a href="https://github.com/resource-watch/dataset/">Dataset microservice</a>, which is built using nodejs. We will discuss the general principles, which should apply to all implementations, as well as implementation details, which may apply to your scenario if you are also using nodejs, or that may not apply if you are using something else.</p>
<h2 id='development-lifecycle'>Development lifecycle</h2>
<p>As a developer of the RW API, your ultimate goal is to make an improvement to the API source code and push it to the production environment. Of course, this is an overly simplistic description of a complex process, and the goal of the next section is to dive deeper into the steps you need to take to achieve that. Breaking this down into a more detailed list, these are the high-level steps you&#39;ll need to take in order to contribute to the RW API:</p>

<ul>
<li>Checkout the code</li>
<li>Run it locally</li>
<li>Make a feature branch</li>
<li>Write your code</li>
<li>Test your feature branch locally</li>
<li>Push your code to Github</li>
<li>Make a PR from your feature branch to <code>dev</code></li>
<li>Wait for Travis&#39; approval, then merge your code</li>
<li>Deploy your changes to the <code>dev</code> cluster for testing in a real-world infrastructure.</li>
<li>Make a PR from <code>dev</code> to <code>staging</code>, wait for Travis&#39; approval, then merge your code.</li>
<li>Make an announcement about an upcoming changes, deploy to <code>staging</code> and test your code with real-world data.</li>
<li>Make a PR from <code>staging</code> to <code>production</code>, wait for Travis&#39; approval, then merge your code.</li>
<li>Make an announcement about an upcoming changes, deploy to <code>production</code> and test your code.</li>
</ul>

<p>In the next sections we&#39;ll dive deeper into the details of each step. </p>
<h2 id='setting-up-a-development-environment'>Setting up a development environment</h2>
<p>In this section, we&#39;ll cover the details of how you can configure your operating system to be used as a development environment for the <a href="https://github.com/resource-watch/dataset/">Dataset microservice</a>, which is built using nodejs. These instructions will apply, without major changes, to all other nodejs-based microservices. For microservices based on Python or Rails, and when using <a href="https://www.docker.com/">Docker</a>, you should also be able to use these instructions. Native execution for Python and Rails microservices is done using equivalent commands, which we&#39;ll outline as we go. </p>

<p>Note that these instructions aim at giving you the details about <strong>what&#39;s specific to the RW API</strong>, and it&#39;s not a step-by-step list of commands you can copy-paste. For example, we will not cover the details of how to install dependencies - that&#39;s something best answered by that particular piece of software&#39;s documentation page for your operating system, which you can easily find with your favourite search engine.</p>

<p>Also, when applying these instruction to different microservices, be sure to review their respective <code>README.md</code> file for a comprehensive list of dependencies you&#39;ll need, or other specific details about its setup process.</p>
<h3 id='execution-native-vs-docker'>Execution - native vs Docker</h3>
<p>All microservices can be executed in two ways: natively or using <a href="https://www.docker.com/">Docker</a>. If you are not familiar with Docker, we suggest briefly learning about it does before proceeding. In a nutshell, it simplifies setup and execution, at the expense of varying performance hit, depending on your operating system. Here are a few key points you should consider when making a decision between executing natively or using Docker:  </p>

<ul>
<li>When using Docker, you typically do not need to set up any other dependency for any microservice - Docker will take care of that for you.</li>
<li>On Windows and Mac, Docker will run a small Linux virtual machine behind the scenes, which will mean a noticeable increase in resource consumption and a reduction in runtime performance, when compared to native execution. When using linux, that does not happen, and runtime performance and resource usage is roughly equivalent to native execution.</li>
<li>Docker does have its quirks, and it does come with a bootstrap time penalty when running your code, so if you are not very familiar with it, or are used to native execution of nodejs, Python or Rails code, it may pay off to use that approach. </li>
<li>The final service will run inside a Docker container. When using Docker containers during development, you reduce the risks of &quot;it worked on my machine&quot; type of problems.</li>
</ul>
<h3 id='using-native-execution'>Using native execution</h3><h4 id='getting-the-code'>Getting the code</h4>
<p>The first step will be getting the source code from <a href="https://github.com/resource-watch/dataset/">Github</a> to your computer using the <a href="https://git-scm.com/">Git</a> CLI (or equivalent). </p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>git clone https://github.com/resource-watch/dataset.git 
</code></pre></div>
<p>Or, if you prefer, you can use:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>git clone git@github.com:resource-watch/dataset.git
</code></pre></div><h4 id='installing-dependencies'>Installing dependencies</h4>
<p>In the source code you just downloaded, you&#39;ll find a <code>README.md</code> file with detailed instruction for the microservice, including dependencies you&#39;ll need to install.</p>

<p>For all Node.js microservices, you&#39;ll need to install <a href="https://nodejs.org/en/">Node.js</a> and <a href="https://yarnpkg.com">Yarn</a>. Rather than installing Node.js from the official website, we recommend using <a href="https://github.com/nvm-sh/nvm">nvm</a>, which allows you to easily install and manage different Node.js versions on your computer, since different microservices may require different versions of Node.js to run.</p>

<aside class="notice">
For Python, you can use something like <a href="https://github.com/pyenv/pyenv">pyenv</a>, and <a href="https://rvm.io/">rvm</a> for Rails-based microservices.
</aside>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="c"># Install Node.js v12 for the dataset microservice</span>
nvm <span class="nb">install </span>12

<span class="c"># Switch to the v12 installation</span>
nvm use 12
</code></pre></div>
<p>Once you&#39;ve installed a version manager like nvm, you need to check which version of the language to install. For Node.js microservices, the <code>package.json</code> file typically has a <code>engine</code> value which will tell you which version(s) of Node.js are supported. Another place where you&#39;ll find this info (which also works for other languages) is the content of the <code>Dockerfile</code> (typically in the first line) - in the dataset microservice, for example, <code>FROM node:12-alpine</code> means this microservice runs on Node.js v12.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="c"># To install dependencies, navigate to the directory where you cloned the microservice and run:</span>
yarn
</code></pre></div>
<p><a href="https://yarnpkg.com">Yarn</a> is a package manager for Node.js applications (a spiritual equivalent to <a href="https://pypi.org/project/pip/">pip</a> for Python or <a href="https://bundler.io/">Bundler</a> for Ruby). Once it&#39;s installed, be sure to use it to install the necessary libraries (see right).</p>

<aside class="notice">
Windows users: If after running <code>yarn</code> you get an error where <code>gyp</code> cannot find Visual Studio, the solution <i>should</i> be as easy as running <code>yarn global add windows-build-tools</code> from an admin command prompt.
</aside>
 

<p>The microservice&#39;s <code>README</code> may specify additional dependencies you need to install. <a href="https://www.mongodb.com/">MongoDB</a>, for example, is a common dependency of many RW API microservices, with applications like <a href="https://www.postgresql.org/">Postgres</a>, <a href="https://redis.io/">Redis</a>, <a href="https://www.rabbitmq.com/">RabbitMQ</a> or <a href="https://opendistro.github.io/for-elasticsearch/">Open Distro for Elasticsearch</a> also being required on certain microservices. If a version number is not identified on the <code>README.md</code> file, the <code>docker-compose-test.yml</code> file may help. <code>image: mongo:3.4</code> means this microservice depends on MongoDB v3.4.</p>

<p>Besides these dependencies, microservices may also depend on the Control Tower gateway, and other microservices: </p>

<ul>
<li>As we&#39;ll cover in the <a href="developer.html#registering-on-control-tower">Registering on Control Tower section</a>, on bootstrap, a microservice will register itself in Control Tower so it can expose its endpoints to the public facing API - but this behavior can be disabled, as we&#39;ll see in a moment.</li>
<li>Microservices expect user data to be provided by Control Tower in a specific format - a workaround for this is passing this data yourself when calling your microservice endpoints</li>
<li><a href="developer.html#requests-to-other-microservices">Requests to other microservices</a> are routed through Control Tower, so if the endpoints you will be developing rely on other microservices, you need to set up both Control Tower and those microservices locally.</li>
<li>Control Tower implements certain endpoints related to user management, which may also be required by the endpoints you&#39;ll be working on.</li>
</ul>

<p>If your endpoint does not rely on other microservices, and you don&#39;t rely on or can spoof the user data provided by Control Tower, you can set the <code>CT_REGISTER_MODE</code> environment variable to a value other than <code>auto</code> to disable the automatic registration on startup, thus removing the dependency on Control Tower. However, this is not recommended, as using Control Tower will have your development environment resemble the production setup, thus potentially highlighting any issues you may otherwise miss.</p>

<p>To set up Control Tower, follow these same instructions, as the process is the same as for any nodejs microservice.</p>

<p><strong>A note on dependencies</strong></p>

<p>Due to a recent infrastructure migration, some <code>README</code> files may mention old dependencies that have since been replaced with newer equivalents. Here are the old dependencies you may find, and their newer equivalent:</p>

<ul>
<li>Elasticsearch 5: it has been replaced by AWS Elasticsearch Service (based on Elasticsearch 7), which is based on <a href="https://opendistro.github.io/for-elasticsearch/">Open Distro for Elasticsearch</a>.</li>
</ul>
<h4 id='configuration'>Configuration</h4>
<p>With the dependencies set up, it&#39;s time to configure the microservice. This is done using <a href="https://en.wikipedia.org/wiki/Environment_variable">environment variables</a> (env vars) which you can define in multiple ways, depending on your OS, way of executing the code (e.g. many IDEs have a &quot;Run&quot; feature that allow configuring environment variables using a GUI) and personal preference. For this tutorial, and going forward, we&#39;ll assume you&#39;ll run the code from a terminal and specify the environment variables inline.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="nv">NODE_ENV</span><span class="o">=</span>production <span class="nv">CT_REGISTER_MODE</span><span class="o">=</span>none &lt;more variables&gt; &lt;your <span class="nb">command</span><span class="o">&gt;</span>
</code></pre></div>
<p>To find out more about which env vars you can/need to specify, refer to the microservice&#39;s <code>README.md</code> file, as it typically documents the main variables available to you. Nodejs-base microservices will often have a full list in the <code>config/custom-environment-variables.json</code> file. The <code>docker-compose-test.yml</code> and <code>docker-compose-develop.yml</code> files contain usages of said variables, and may be helpful if you are looking for an example or an undocumented variable.</p>

<p>As a rule of thumb, env vars configure things like databases address and credentials, 3rd party services (for example, an AWS S3 bucket URL or AWS access credentials), or Control Tower URL (only necessary if you decide to use it).</p>
<h4 id='starting-the-microservice'>Starting the microservice</h4><div class="highlight"><pre class="highlight shell tab-shell"><code><span class="c"># Starting a Node.js microservice:</span>
yarn start

<span class="c"># Node.js using inline environment variables:</span>
<span class="nv">NODE_ENV</span><span class="o">=</span>production <span class="nv">CT_REGISTER_MODE</span><span class="o">=</span>none &lt;your other environment variables&gt; yarn start

<span class="c"># Starting a Python microservice may look something like this:</span>
python main.py

<span class="c"># Rails-based microservices can rely on the traditional Rails CLI:</span>
rails server
</code></pre></div>
<p>Once you have determined the values you&#39;ll need to run your microservice with the desired configuration, you should have everything ready to run it. For nodejs based microservice like Dataset, you can do this by running <code>yarn start</code>. For other languages, the startup command will be different (see right).</p>

<p>You can also review the <code>entrypoint.sh</code> file content, under the <code>start</code> or <code>develop</code> sections, as it will contain the command you need to execute to run the code natively.</p>

<p>The application should output useful information, like database connection status and HTTP port. Depending on your configuration for the Control Tower auto registration, it will also output the result of that process. Overall, if no error message is produced, the microservice should be up and running, and available at the port specified by its output.</p>
<h4 id='running-the-tests'>Running the tests</h4><div class="highlight"><pre class="highlight shell tab-shell"><code><span class="c"># Running tests for a Node.js microservice:</span>
yarn <span class="nb">test</span>

<span class="c"># Node.js with environment variables:</span>
<span class="nv">NODE_ENV</span><span class="o">=</span><span class="nb">test </span><span class="nv">CT_REGISTER_MODE</span><span class="o">=</span>none &lt;your other environment variables&gt; yarn <span class="nb">test</span>

<span class="c"># Python:</span>
<span class="nb">exec </span>pytest &lt;<span class="nb">test </span>folder&gt;

<span class="c"># Ruby:</span>
bundle <span class="nb">exec </span>rspec spec
</code></pre></div>
<p>Most microservices (hopefully all in the future) come with tests included. Running these tests can help you identify issues with your code changes, and are required for any new modifications merged into the RW API. It&#39;s recommended that you run tests locally before pushing changes to Github.</p>

<p>Tests sometimes mock certain dependencies, like external 3rd party service, but often require an actually running database, as a native execution would (think MongoDB or Postgres). Check the <code>docker-compose-test.yml</code> for whatever services it runs besides the microservice - those are the dependencies you&#39;ll need to have up and running to run the tests natively. Control Tower is not required to run the tests.</p>

<p>Test execution requires roughly the same env vars as running the actual microservice. For microservices that rely on a database, make sure you are not using the same database as you do for development purposes - tests assume database isolation, and will delete preexisting data.</p>

<p>See right for how to run tests for microservices in different languages. You can also review the <code>entrypoint.sh</code> file content, under the <code>test</code> section, which will contain the exact command you need to execute.</p>
<h4 id='common-errors-and-pitfalls'>Common errors and pitfalls</h4>
<ul>
<li><strong>Your microservice cannot connect to MongoDB/other database</strong>: ensure that the corresponding service is running and listening on the configured address and port - be mindful that <code>localhost</code>, <code>127.0.0.1</code> and your local IP are not always interchangeable. Also confirm user and password data.</li>
<li><strong>Your microservice crashes shortly after start, trying to reach a network address</strong>: this may be your microservice trying to reach Control Tower. Either disable Control Tower auto registration, or run Control Tower.</li>
<li><strong>Your microservice crashes when handling an API call, trying to reach a network address</strong>: this may be your microservice trying to reach another microservice through Control Tower. Make sure that both Control Tower and the necessary dependent microservices are up and running, and that all microservices involved are registered in Control Tower. Be sure that Control Tower&#39;s cron is running. Be sure you are using the correct and up-to-date versions of Control Tower and dependent microservices.</li>
<li><strong>Your microservice has user-related issues, even though you are providing a <code>Bearer</code> token</strong>: Bearer tokens are processed by Control Tower, and transformed into a <code>loggedUser</code> JSON object that microservices expect. Either provide said object directly to your microservice, or route your request with the token through Control Tower.</li>
<li><strong>Your tests keep failing</strong>: This can be due to multiple reasons. Check the microservice&#39;s travis status (link in the README.md) to see if it&#39;s just you, or if there&#39;s an issue with the preexisting code base. Run your tests a few more times and see if the output is consistent - some tests are not deterministic, and have varying results. Ensure your env vars are correct - check <code>docker-compose-test.yml</code> or <code>.travis.yml</code> for examples on values.</li>
</ul>
<h3 id='using-docker'>Using Docker</h3><h4 id='getting-the-code-2'>Getting the code</h4>
<p>The first step will be getting the source code from <a href="https://github.com/resource-watch/dataset/">Github</a> to your computer using the <a href="https://git-scm.com/">Git</a> CLI (or equivalent). </p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>git clone https://github.com/resource-watch/dataset.git 
</code></pre></div>
<p>Or, if you prefer, you can use:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>git clone git@github.com:resource-watch/dataset.git
</code></pre></div>
<aside class="notice">
Make sure to checkout with `--config core.autocrlf=input`. This avoids an issue between Docker and Windows when handling line endings.
</aside>
<h4 id='installing-dependencies-2'>Installing dependencies</h4>
<p>As we mentioned before, if you decide to use Docker, your only dependency will be Docker itself (and docker-compose, which comes included). Depending on your OS, Docker installation instructions will differ, but your favourite web search engine will hopefully point you in the right direction.</p>

<p>When you run Docker, it will automatically fetch the necessary dependencies and run them for you. However, if you are not using Linux, you may have to fine-tune some settings so that dependencies like MongoDB can communicate with your microservice - we&#39;ll review this in detail in a bit.</p>

<p>Note that Docker will not fetch nor run Control Tower for you - if you want to execute your microservice in integration with Control Tower, you&#39;ll have to set it up manually. Alternatively, set the <code>CT_REGISTER_MODE</code> <a href="https://en.wikipedia.org/wiki/Environment_variable">environment variable</a> to any value other than <code>auto</code>.</p>
<h4 id='configuration-2'>Configuration</h4>
<p>Configuration for Docker based execution is done using <a href="https://en.wikipedia.org/wiki/Environment_variable">environment variables</a> (env vars) passed to the Docker runtime using a special <code>dev.env</code> file. Some microservices will include a <code>dev.env.sample</code> or equivalent that you can copy-paste and use as a starting point when configuring your environment.</p>

<p>To find out more about which env vars you can/need to specify, refer to the microservice&#39;s <code>README.md</code> file, as it typically documents the main variables available to you. Nodejs-base microservices will often have a full list in the <code>config/custom-environment-variables.json</code> file. The <code>docker-compose-test.yml</code> and <code>docker-compose-develop.yml</code> files contain usages of said variables, and may be helpful if you are looking for an example or an undocumented variable.</p>

<p>As a rule of thumb, env vars configure things like databases address and credentials, 3rd party services (for example, an AWS S3 bucket URL or AWS access credentials), or Control Tower URL (only necessary if you decide to use it). Your docker-compose file may already have predefined values for some of these, in which case do not overwrite them unless you are certain of what you&#39;re doing.</p>

<p>Docker networking works differently on Linux vs other operating systems, and you need to keep this in mind when specifying values for things like MongoDB or Control Tower addresses. Under Linux, Docker containers and the host operating system run in the same network host, so you can use <code>localhost</code>, for example, when telling a dockerized Dataset microservice where it can reach Control Tower (running natively or in a Docker container). Under other operating systems, however, Docker containers run on a different network host, so you should instead use your local network IP - using <code>localhost</code> will not reach your expected target. </p>
<h4 id='starting-the-microservice-2'>Starting the microservice</h4>
<p>For convenience, most microservices include a unix-based script that will run the Docker command that will start your microservice, along with the dependencies covered by Docker. The file name will vary from microservice to microservice, and the argument may also vary, but it&#39;s usually something along the lines of:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>./dataset.sh develop
</code></pre></div>
<p>Mac users&#39; mileage may vary with these scripts, and Windows users will need to manually open these file and reproduce the included logic in Windows-compatible syntax - don&#39;t worry, they are pretty simple and easy to understand. </p>

<p>Docker will take a few minutes to run, especially during the first execution, but once it&#39;s up and running, you should see the HTTP address where your microservice is available in the output printed to the console.</p>
<h4 id='running-the-tests-2'>Running the tests</h4>
<p>Running tests under Docker is similar to running the actual microservice. The easiest way to do so, for unix-based OSs is using the included <code>.sh</code> helper file:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>./dataset.sh <span class="nb">test</span>
</code></pre></div><h4 id='common-errors-and-pitfalls-2'>Common errors and pitfalls</h4>
<ul>
<li><strong>Your microservice cannot connect to MongoDB/other database</strong>: this can happen with Docker setups if the database container takes longer to start than the microservice container - which is common on first time executions. Re-run the docker-compose command fixes it most times. Check if the address, port, username and password values on the <code>dev.env</code> file are correct - most of the time, the default values will work, and your <code>dev.env</code> file should not override them.</li>
<li><strong>Your microservice crashes shortly after start, trying to reach a network address</strong>: this may be your microservice trying to reach Control Tower. Either disable Control Tower auto registration, or run Control Tower. Ensure that the address and port pointing to Control Tower are correct - typically you need to use your private IP address (<code>localhost</code> or <code>127.0.0.1</code> won&#39;t do for non linux OSs).</li>
<li><strong>Your microservice crashes when handling an API call, trying to reach a network address</strong>: this may be your microservice trying to reach another microservice through Control Tower. Make sure that both Control Tower and the necessary dependent microservices are up and running, and that all microservices involved are registered in Control Tower. Be sure that Control Tower&#39;s cron is running.</li>
<li><strong>Your microservice has user-related issues, even though you are providing a <code>Bearer</code> token</strong>: Bearer tokens are processed by Control Tower, and transformed into a <code>loggedUser</code> JSON object that microservices expect. Either provide said object directly to your microservice, or route you request with the token through Control Tower.</li>
<li><strong>Your tests keep failing</strong>: This can be due to multiple reasons. Check the microservice&#39;s travis status (link in the README.md) to see if it&#39;s just you, or if there&#39;s an issue with the preexisting code base. Run your tests a few more times and see if the output is consistent - some tests are not deterministic, and have varying results.</li>
</ul>
<h2 id='ci-cd'>CI/CD</h2>
<p>The RW API uses multiple tools in it&#39;s <a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> and <a href="https://en.wikipedia.org/wiki/Continuous_delivery">CD</a> pipelines. All microservices that compose the RW API use a common set of tools:</p>

<ul>
<li><a href="https://github.com">Github</a> for version control and code repository.</li>
<li><a href="travis-ci.org/">Travis CI</a> for automatic test execution.</li>
<li><a href="codeclimate.com/">Code Climate</a> for code coverage monitoring.</li>
<li><a href="https://www.jenkins.io/">Jenkins</a> for deployment.</li>
</ul>

<p>We assume, at this point, that you&#39;re already familiar with Github and its core functionality, like branches and pull requests (PRs). If that&#39;s not the case, use your favourite search engine to learn more about those concepts.</p>

<p>Each microservice lives in a separate Github repository, most of which have Travis and Code Climate integrations configured. Whenever a pull request is created, both tools will be triggered automatically - Travis will run the tests included in the code, and notify the PR author of the result. Code Climate builds on top of that, and monitors and reports <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a>. The behavior of both tools is controlled by a single <code>.travis.yml</code> file you&#39;ll find in the root of each microservice&#39;s code base, and you can learn about it on each of the tool&#39;s documentation page. You can see the result directly on the PR page.</p>

<p>When you want to submit a change to the code of one of the microservices, you should:</p>

<ul>
<li>Do your changes in a separate git branch, named after the change you&#39;re making.</li>
<li>Target the <code>dev</code> branch (or <code>develop</code>, if <code>dev</code> does not exist yet - we&#39;re in the process of migrating to a <code>dev</code>+<code>staging</code>+<code>production</code> branch structure, but haven&#39;t done so for all repos yet).</li>
<li>Include tests to cover the change you&#39;re making.</li>
<li>Ensure your PR tests pass when executed by Travis.</li>
<li>Maintain/increase the code coverage value reported by Code Climate.</li>
<li>Briefly describe the changes you&#39;re doing in a <code>CHANGELOG.md</code> entry and, if these are public-facing, do a PR to the <a href="github.com/resource-watch/doc-api">RW API documentation repository</a>.</li>
</ul>

<p>At this stage, and even if your tests pass locally, they may fail when executed in Travis. We recommend running them again if this happens, to see if any <a href="https://whatis.techtarget.com/definition/hiccup">hiccup</a> occurred. If that&#39;s not the case, look into the Travis logs to learn more. Unfortunately, the reasons for these are diverse. It can be related to env vars defined inside the <code>.travis.yml</code> file, missing or incorrectly configured dependencies, differences in packages between your local environment and Travis&#39;, etc. At the time of writing, and by default which can be overridden, Travis uses Ubuntu and is configured to <a href="developer.html#using-native-execution">use native execution</a> when running tests, so using that very same approach locally may get you closer to the source of the problem you&#39;re experiencing. Travis&#39; output log will usually help you identify what&#39;s happening, and get you closer to a solution.</p>

<p>Once reviewed by a peer, your changes will be merged and will be ready for deployment to one of the live environments.</p>

<p>Currently, the RW API has 3 different environments:</p>

<ul>
<li><code>dev</code> at <a href="https://aws-dev.resourcewatch.org">https://aws-dev.resourcewatch.org</a> for internal testing and development of new features. There are no guarantees of stability or data persistence. While it&#39;s not barred from public access, it&#39;s meant to be used only by developers working on the RW API code, for testing, debugging and experimentation.</li>
<li><code>staging</code> at <a href="https://staging-api.resourcewatch.org/">https://staging-api.resourcewatch.org/</a> is a more stable environment, meant to be used by both the RW API developers as well as other developers working on applications built using the RW API. It aims to be functionally stable, but occasional interruptions may occur if needed as part of a process, and code is sometimes in &quot;release candidate&quot; status, meaning it can have some issues. Data is often relied on by users of this API, so be mindful when performing destructive actions.</li>
<li><code>production</code> at <a href="https://api.resourcewatch.org/">https://api.resourcewatch.org/</a> is meant to be as stable as possible, as it&#39;s used by real users.</li>
</ul>

<p>Each microservice repository has a branch matching the name of each of these 3 environments, and changes will always go from a feature branch to <code>dev</code>, then to <code>staging</code>, and finally to <code>production</code>. To push your changes across the different environments, you should:</p>

<ul>
<li>Create a PR from the source branch to the target branch (from <code>dev</code> to <code>staging</code>, or from <code>staging</code> to <code>production</code>)</li>
<li>Deploy the code to the respective environment (we&#39;ll see how in a moment)</li>
<li>Test it with actual calls to the API, to validate that no side effects were introduced.</li>
</ul>

<p>Depending on the scale of the changes you&#39;re doing, it&#39;s recommended to use <a href="https://git-scm.com/book/en/v2/Git-Basics-Tagging">git tags</a> with <a href="https://semver.org/">semantic versioning</a>. Also be sure to update the <code>CHANGELOG.md</code> accordingly, and the <code>package.json</code> or equivalent files if they refer a version number. </p>

<p>Changes being pushed to either <code>production</code> or <code>staging</code> should be announced in advance in the <code>general</code> channel in the WRI API Slack (and to contact Ethan Roday if you&#39;re not in that Slack workspace). Specifically, for changes going to <code>production</code>, that notice period should be of at least 14 days, during which said changes should be available in <code>staging</code> for testing by everyone. In rare cases, if a hotfix is needed to fix a breaking change in <code>production</code>, the 14-day lead time can be circumvented, but an announcement still must be made. </p>

<p>It&#39;s also best practice to announce the changes you&#39;re about to deploy before doing so, so that other developers of RW API applications can be on the lookout for regressions, and can quickly get in touch with you should any undesired behavior change be detected.</p>

<p>Each of the referred environments lives on a separate <a href="https://kubernetes.io/">Kubernetes</a> cluster (hosted with <a href="https://aws.amazon.com/eks/">AWS EKS</a>), and deployment is done using individual Jenkins instances:</p>

<ul>
<li><a href="https://jenkins.aws-dev.resourcewatch.org">Jenkins for the dev environment</a></li>
<li><a href="https://jenkins.aws-staging.resourcewatch.org">Jenkins for the staging environment</a></li>
<li><a href="https://jenkins.aws-prod.resourcewatch.org">Jenkins for the production environment</a></li>
</ul>

<p>All 3 instances have similar overall configuration, but different microservices may deploy differently depending on the behavior coded into the <code>Jenkinsfile</code> that&#39;s part of their source code - for example, some WRI sites are also deployed using this approach, but opt to deploy both staging and production versions to the <code>production</code> cluster, and may not be in the <code>staging</code> or <code>dev</code> Jenkins. However, the majority of services follow the convention of a single branch per Jenkins instance, with the branch name matching the name of the respective environment. </p>

<p>The list of jobs you find on each Jenkins instance will match the list of services deployed on that environment. In the details of each job, you should find a branch named after the environment, which corresponds to the Github branch with the same name (some services may still have the old approach, with <code>develop</code> for <code>dev</code> and <code>staging</code>, and <code>master</code> for <code>production</code>). You may also find other branches, or a different branch structure, depending on the service itself - again, the <code>Jenkinsfile</code> configuration is king here, and you should refer to it to better understand what is the desired behavior per branch. In some cases, old branches will be listed on Jenkins but should be ignored.</p>

<p>Deployments need to be triggered manually, on a per-microservice and per-branch basis. Once a deployment starts, Jenkins will run the <code>Jenkinsfile</code> content - it is, after all, a script - and perform the actions contained in it. While it&#39;s up to the maintainer of each microservice to modify this script, more often than not it will run the tests included in the microservice, using Docker, and if these pass, push the newly generated Docker image to <a href="https://hub.docker.com/">Docker Hub</a>. It will then update the respective Kubernetes cluster with content of the matching subfolder inside the <code>k8s</code> folder of the microservice, plus the <code>k8s/service</code> folder if one exists. The last step is to deploy the recently pushed Docker image from Docker Hub to the cluster, which will cause Kubernetes to progressively replace running old instances of the service with ones based on the new version.</p>

<p><strong>A couple of important notes here:</strong></p>

<ul>
<li>All code deployed this way is made public through Docker Hub. If you have sensitive information in your codebase, and are using a Github private repository but are deploying using this approach, your information is NOT kept private.</li>
<li>When deploying to production, most microservices will have an additional step at the end of the <code>Jenkinsfile</code> execution, which will require a human to explicitly click a link at the end of the Jenkins build log to trigger a deployment to the cluster. This is made intentionally so that deployment to the production environment are explicit and intentional, and are not triggered by accident.</li>
</ul>

<p>While it&#39;s rare, tests ran by Jenkins at this stage may also fail, preventing your deployment. In these cases, refer to the Jenkins build log for details, which most of the times can be reproduced locally <a href="developer.html#running-the-tests69">running your tests using Docker</a>. If your Jenkins log mentions issues related with disk capacity or network address assignment problems, please reach out to someone with access to the Jenkins VMs and ask for a <a href="https://docs.docker.com/engine/reference/commandline/system_prune/">docker system prune</a>.</p>
<h2 id='infrastructure-configuration'>Infrastructure configuration</h2>
<p>While the workflow above will cover most of the changes you&#39;ll do as an RW API developer - changes to the code that powers the API - from time to time you&#39;ll need to adjust the actual infrastructure on which the API runs. This section covers what you need to know to be able to manage the infrastructure.</p>
<h3 id='infrastructure-as-code-using-terraform'>Infrastructure as code using Terraform</h3>
<p>Each of the 3 RW API environments lives on a separate AWS account. Aside from scale-related aspects, the 3 infrastructures are meant to be as equal to each other as possible. To achieve this, as well as ease of maintenance, infrastructure is maintained using <a href="https://www.terraform.io/">Terraform</a>, an <a href="https://en.wikipedia.org/wiki/Infrastructure_as_code">infrastructure as code</a> tool. If you are not familiar with Terraform, we recommend learning about it before proceeding.</p>

<p>Due to the structure of the RW API infrastructure, the final architecture is defined by 2 Terraform projects:</p>

<ul>
<li><a href="https://github.com/resource-watch/api-infrastructure/tree/production/terraform">The AWS Terraform project</a> contains lower level elements, like networking, a <a href="https://en.wikipedia.org/wiki/Bastion_host">bastion host</a>, Jenkins and an AWS EKS Kubernetes cluster. This configuration is automatically applied to each AWS account using <a href="https://github.com/features/actions">Github Actions</a> when merged to the respective branch. Github actions are also used to run a <code>terraform plan</code> preview of changes for each Pull Request.</li>
<li><a href="https://github.com/resource-watch/api-infrastructure/tree/production/terraform-k8s-infrastructure">The Kubernetes Terraform project</a> mostly contains the configuration for Kubernetes services, as well as some database-level services. Unlike the previous, this Terraform project needs to be applied manually, using the <code>terraform apply</code> command.</li>
</ul>

<p>The Kubernetes Terraform project relies on the resources provisioned by the AWS Terraform project (which is why they <a href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs#stacking-with-managed-kubernetes-cluster-resources">can&#39;t be merged into a single one</a>), so be sure that they are applied in that order. </p>

<p>While the Kubernetes Terraform project contains an increasingly large portion of the overall Kubernetes configuration, there are some additional Kubernetes elements provisioned outside of it.</p>

<ul>
<li><a href="https://github.com/resource-watch/api-infrastructure/tree/production/k8s-aws">Some resources</a> are provisioned using traditional YAML files, that need to be manually applied using <code>kubectl apply</code> once the Kubernetes cluster is up and running. The link above contains not only said YAML files, but also associated documentation.</li>
<li><a href="https://kubernetes.io/docs/concepts/configuration/secret/">Kubernetes secrets</a> are kept in a separate, private repository. Said repository has multiple YAML files, and organized by cluster, and then by Kubernetes namespace. Each of these YAML files needs to be manually applied whenever needed.</li>
</ul>
<h3 id='access-to-infrastructure-resources'>Access to infrastructure resources</h3>
<p>For management or debug purposes, you may need to access the infrastructure resources. Depending on what you want to achieve, there are multiple paths forward. However, for all of them, a common required element is an AWS account with the adequate permissions. These permissions will depend on what you&#39;re trying to achieve in particular. The AWS IAM permission mechanism is too powerful and complex to cover here, so be prepared to see a few &quot;permission denied&quot; from time to time, and to discuss with your fellow RW API developers what permissions you are missing that will allow you to access a give resource.</p>
<h4 id='infrastructure-details'>Infrastructure details</h4>
<p>Infrastructure details are accessible in multiple ways, depending on exactly what you&#39;re looking for. </p>

<p>If you are looking for a high-level piece of information (like &quot;how many CPUs are we running?&quot;), you may use the AWS Console directly, as it provides a simple UI for a lot of information. Alternatively, investigating the Terraform files are a good way to learn about what services are configured overall, without having to browse every page of the AWS Console, or worry that you may be looking in the wrong AWS Region.</p>

<p>Finally, for very low level details, AWS has a CLI tool that may expose information not available through the channels mentioned above.</p>

<p>In all scenarios, if you are looking to permanently modify the infrastructure, keep in mind that the Terraform projects are kings here, and any change made using either the AWS Console or AWS CLI that is not persisted to Terraform should be considered ephemeral, as it may be overwritten at any time without prior warning. You may, however, modify the infrastructure using the AWS Console or AWS CLI as a means of experimentation, before projecting your final changes on Terraform. </p>
<h4 id='infrastructure-access'>Infrastructure access</h4>
<p>Infrastructure access is often need as a way to access things like Kubernetes, database dumps, system status, etc. It&#39;s not an end in itself, but rather a necessary step to achieve other goals. To configure your infrastructure access, you&#39;ll need two elements. </p>

<p>The first of which is a running and configured <a href="https://aws.amazon.com/cli/">AWS CLI</a> tool installation. The AWS CLI tool has comprehensive documentation, which should also cover the install steps for your particular operating system. To configure it you&#39;ll also need the AWS account covered in the previous section.</p>

<p>The second element you&#39;ll need is access to the <a href="https://en.wikipedia.org/wiki/Bastion_host">bastion host</a>. If you are not familiar with bastion hosts, we recommend reading about it before proceeding but, in a nutshell, a bastion host works as a single point of entry into key parts of the infrastructure, which are otherwise inaccessible from the public internet. A way to contact a service running in the infrastructure from the outside world is creating an SSH tunnel that proxies traffic to that service through the bastion host, thus bypassing this restriction. For this to work, you need SSH access to the bastion host, which a fellow RW API developer may grant you.</p>

<p><code>shell script
ssh -N -L &lt;local port&gt;:&lt;target service address&gt;:&lt;target service port&gt; &lt;bastion host user&gt;@&lt;bastion host address&gt;
</code></p>

<p>To create an SSH tunnel under a unix-based system, you&#39;ll need to run a command like the example here.</p>
<h4 id='database-access'>Database access</h4>
<p>Access to databases (to extract a dump for testing, for example) depends on how said database service is configured. At the time of writing, some database services run as AWS managed services, while other live inside the Kubernetes cluster, as Kubernetes services. </p>

<p>For database services provided by AWS managed services, the only necessary steps are the ones covered previously on the <a href="developer.html#infrastructure-access">Infrastructure access</a> section. After that, you should be able to reach the host of the database service, per details provided by the service itself. You may also need authentication details for a specific service, which you may find either on the Terraform configuration, the Kubernetes secrets files or AWS secret storage.</p>

<p>For access to database services running as a Kubernetes service, you&#39;ll need Kubernetes access (which we will cover next). Once you have that configured, you should configure a <a href="https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/">Kubernetes port forward</a> to map said service to a port of your local host. Access credentials are typically available on the Kubernetes secrets files.</p>
<h4 id='kubernetes-access'>Kubernetes access</h4>
<p>The RW API runs in a AWS EKS Kubernetes cluster, which can be accessed using the <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">kubectl</a> command line tool, which you should install on your computer. You also need the elements previously covered in the <a href="developer.html#infrastructure-access">Infrastructure access</a> section, so be sure that your AWS CLI is installed and configured, and that you have a way to communicate with the infrastructure&#39;s inner elements.</p>

<p>To configure <code>kubectl</code>, you will need some details that are specific to the kubernetes cluster you&#39;re trying to access. Said details are available as the output of the <code>terraform apply</code> command that&#39;s executed by Github Actions for the <a href="https://github.com/resource-watch/api-infrastructure/tree/production/terraform">AWS Terraform project</a>. Be mindful that, amongst those details, is the URL through which <code>kubectl</code> should contact the Kubernetes control plane. Given that you are using an SSH tunnel, you should:</p>

<ul>
<li>Modify the Kubernetes URL in the <code>kubectl</code> by adding a custom port value to it (say 4433, for the sake of example)</li>
<li>Modify the you local hosts file so that the Kubernetes URL is resolved to your 127.0.0.1 IP (or equivalent)</li>
<li>Create a SSH tunnel that maps your local port (the 4433 from the example above) to the actual EKS URL and port, proxied through the bastion host.</li>
</ul>
<div class="highlight"><pre class="highlight shell tab-shell"><code>ssh <span class="nt">-N</span> <span class="nt">-L</span> 4433:&lt;EKS URL&gt;:443 &lt;bastion host user&gt;@&lt;bastion host URL&gt;
</code></pre></div>
<p>Here&#39;s an example of how you could create said SSH tunnel:</p>
<h4 id='log-access'>Log access</h4>
<p>Logs for the whole infrastructure are centralized in AWS Cloudwatch. Optionally, if you find it more convenient, you can opt to use <code>kubectl</code> to access logs for a particular pod or container, but you&#39;ll also find that output on AWS Cloudwatch.</p>

<p>Certain AWS managed services&#39; logs will only be available on Cloudwatch, so we encourage you to learn how to navigate it.</p>
<h2 id='testing-your-changes'>Testing your changes</h2>
<p>With your code live on one of the clusters, you should now proceed to testing it. The type of tests you should run vary greatly with the nature of the changes you did, so common sense and industry best practices apply here:</p>

<ul>
<li>The bigger the change, the broader the testing should be.</li>
<li>Test your changes with different types of users, <code>applications</code>, payloads, etc.</li>
<li>Try to break your code - send unexpected input, try to access resources you should not have access to, etc. More important than doing what it should is not doing what it shouldn&#39;t .</li>
<li>If you can, ask for help - testing can be seen as an exercise in creativity, and having someone&#39;s assistance will help think outside the box.</li>
<li>If you find a bug, fix it, and test everything again, not only what you just fixed.</li>
<li>If a test is &quot;simple&quot;, write it as a code test, which is reproducible. Save manual testing for the complex scenarios.</li>
<li>Test the assumptions you used for behavior of other microservices - E2E testing mocks other microservices, so this may be the first time your code is running alongside real instances of other microservices.</li>
<li>Clean up after your tests - if you created a bunch of test data, do your best to delete it once you&#39;re done. This is particularly important if you are testing something in the production environment, as that test data may be visible to real world users. Cleaning up in staging is also highly recommended.</li>
</ul>

<p>If you are implementing a new endpoint and it&#39;s mission critical to the RW API or one of the applications it powers, you may want to add a <a href="developer.html#api-smoke-tests">API smoke test</a> to ensure that any issue affecting its availability is detected and reported. Refer to that section of the docs for more details.</p>
<h2 id='microservice-internal-architecture-nodejs'>Microservice internal architecture - nodejs</h2>
<aside class="notice">
This section is completely implementation specific and opinionated, and does not reflect any technical requirement of the API. However, as all nodejs microservices use this architecture, we will cover it here as it's useful for new developers. Other microservice implementations in other languages will have different architectures, and you can also implement your own microservice using nodejs using a totally different architecture. Take this whole section as information/suggestion rather than as a ruleset.
</aside>

<p>Nodejs microservices are based on the <a href="https://koajs.com/">Koa</a> framework for nodejs. To understand the following code snippets, we assume you are familiar with the basics of the framework, like how routes are declared and handled, what middleware is, and how it works. You should also be somewhat familiar with tools like <a href="https://www.npmjs.com/">npm</a>, <a href="https://www.mongodb.com/">mongo</a> and <a href="https://mongoosejs.com/">mongoose</a>, <a href="https://jenkins.io/">Jenkins CI</a>, <a href="https://www.docker.com/">docker</a> and <a href="https://docs.docker.com/compose/">docker-compose</a></p>
<h3 id='anatomy-of-a-nodejs-microservice'>Anatomy of a (nodejs) microservice</h3>
<p>In this section, we&#39;ll use <a href="https://github.com/resource-watch/dataset">the dataset microservice</a> as an example, but these concepts should apply to most if not all nodejs microservices:</p>

<ul>
<li>app: source code for the microservice functionality.</li>
<li>config: configuration for different environments in which the microservice will be executed.</li>
<li>k8s: <a href="https://kubernetes.io/">kubernetes</a> configuration.</li>
<li>Jenkinsfile: deployment configuration for <a href="https://jenkins.io/">Jenkins CI</a>.</li>
<li>dataset.sh: convenience executable file (the name will always match the microservice).</li>
<li>docker-compose-develop.yml: <a href="https://docs.docker.com/compose/">docker-compose</a> configuration for develop environment.</li>
<li>docker-compose-test.yml: <a href="https://docs.docker.com/compose/">docker-compose</a> configuration for test environment.</li>
<li>docker-compose.yml: <a href="https://docs.docker.com/compose/">docker-compose</a> configuration for production environment.</li>
<li>entrypoint.sh: <a href="https://www.docker.com/">docker</a> entry point.</li>
</ul>

<p>Since we are interested in the microservice&#39;s functional bits, we&#39;ll analyse the <code>app</code> folder content in more detail. It&#39;s worth mentioning that, depending on how you run the microservice, the respective <code>docker compose</code> files may contain relevant information and configuration, as do the files inside the <code>config</code> folder.</p>

<p>The <code>app</code> folder contains the following structure:</p>

<ul>
<li>microservice: JSON files used during the Control Tower registration process.</li>
<li>src: source code for the microservice.</li>
<li>test: test source code.</li>
<li>Gruntfile.js: <a href="https://gruntjs.com/">grunt</a> task definition file.</li>
<li>index.js: nodejs entry point.</li>
</ul>

<p>The grunt file includes several task definition that may be useful during day-to-day development. However, grunt is semi-deprecated (it&#39;s still needed, don&#39;t remove it) in the sense that it&#39;s recommended to define useful tasks in the <code>package.json</code> file instead - those tasks will, in turn, call grunt tasks.</p>

<p>Inside the <code>app/src</code> folder you&#39;ll find the following structure. The folders below will be commonly found on all microservice, unless stated otherwise:</p>

<ul>
<li>data: data files. This folder is specific to the dataset microservice.</li>
<li>errors: error classes for specific scenarios, which then in turn translate into specific HTTP codes and responses.</li>
<li>models: <code>mongose</code> models to ease integration with <code>mongo</code>.</li>
<li>routes: <code>koa</code> route and request handling definition, as well as middleware.</li>
<li>serializers: <code>mongoogse</code> model to JSON response serializers.</li>
<li>services: application business logic.</li>
<li>validators: input validators.</li>
<li>app.constants.js: microservice application constants.</li>
<li>app.js: <code>koa</code> bootstrap, as well as basic error handling and Control Tower registration.</li>
<li>loader.js: convenience file that iterates over the nested content of the <code>routes</code> folder and loads files.</li>
<li>logger.js: convenience file that configures the logger for ease of use.</li>
</ul>
<h3 id='adding-a-new-endpoint'>Adding a new endpoint</h3>
<p>In this section we&#39;ll cover how you can add a new endpoint with new functionality to an existing microservice. The aim is not to be a comprehensive guide to cover all cases, but more of a quick entry point into day-to-day actions you may want to perform, which should be complemented by your own learning of how a microservice works - remember that all microservices, despite being structurally similar, have their own custom code and functionality.</p>

<p>To add a new endpoint, here&#39;s the short tasklist you have to tackle:</p>

<ul>
<li>Register your route in koa.</li>
<li>Add a handler for that route.</li>
<li>Add middleware for validation, if applicable.</li>
<li>Implement new services, models or serializers to handle your application logic, if applicable.</li>
<li>Add tests for your functionality (you may want to start with this, if TDD is your thing).</li>
<li>Update the Control Tower registration file.</li>
</ul>
<h3 id='register-your-route-in-koa'>Register your route in koa</h3>
<p>Route registration is done using the <a href="https://github.com/ZijianHe/koa-router">koa-router</a> library, and can be done in the <code>app/src/routes/api/v1/dataset.router.js</code> file, usually at the bottom of if:</p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code>
<span class="c1">// router object declaration, usually at the top of the file</span>
<span class="kd">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
    <span class="na">prefix</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/dataset</span><span class="dl">'</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// routes declaration, usually at the bottom of the file</span>
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">getAll</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/find-by-ids</span><span class="dl">'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">findByIds</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">authorizationBigQuery</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span>
<span class="c1">// router.post('/', validationMiddleware, authorizationMiddleware, authorizationBigQuery, authorizationSubscribable, DatasetRouter.create);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/upload</span><span class="dl">'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">upload</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset/flush</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">flushDataset</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset/recover</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authorizationRecover</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">recover</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset</span><span class="dl">'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="kd">get</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset/verification</span><span class="dl">'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">verification</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset</span><span class="dl">'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset</span><span class="dl">'</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/:dataset/clone</span><span class="dl">'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">clone</span><span class="p">);</span>
</code></pre></div>
<p>In here you&#39;ll find the already existing routes. As you can see from the rather explicit syntax, you need to call the method that matches the desired HTTP verb on the <code>router</code> object, and pass it a variable number of arguments - more on this in the next section. One thing to keep in mind is that all the routes in a file are typically prefixed, as defined in the <code>router</code> object declaration.</p>
<h2 id='control-tower-integration'>Control Tower integration</h2>
<p>While they could technically work as standalone applications, microservices are built from the ground up to work through Control Tower. As such, not only do they lack built-in functionality provided by Control Tower itself (for example, user management), they also need to handle their own integration with Control Tower. Control Tower provides integration libraries for certain languages and frameworks, which you can use to ease development:
- <a href="https://github.com/control-tower/ct-register-microservice-node">nodejs package for Koa</a>
- <a href="https://github.com/control-tower/ct-register-microservice-python-flask">Python module for Flask</a>
- <a href="https://github.com/control-tower/ct-register-microservice-rails">Rails engine</a></p>

<p>These libraries provide 2 basic features that we&#39;ll cover in detail in this chapter. You can also use it for reference in case you want to implement a microservice in a different programming language or framework. </p>

<p>We&#39;ll use the nodejs library as reference and example in the following sections, as it&#39;s the most commonly used language in this API. Other libraries will provided the same underlying functionality, but may have different ways to operate. Refer to each library&#39;s specific documentation for more details.</p>
<h3 id='registering-on-control-tower'>Registering on Control Tower</h3>
<p>The first feature provided by these libraries, and that a microservice must perform, is registering on Control Tower. Most of the details of this process can be found on <a href="developer.html#microservice-registration-process">Control Tower&#39;s documentation</a>, which you should read at this point if you haven&#39;t already.</p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="c1">// dataset microservice registration example</span>

<span class="kd">const</span> <span class="nx">ctRegisterMicroservice</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ct-register-microservice-node</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">koa</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">logger</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
        <span class="na">info</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../microservice/register.json</span><span class="dl">'</span><span class="p">),</span>
        <span class="na">swagger</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">../microservice/public-swagger.json</span><span class="dl">'</span><span class="p">),</span>
        <span class="na">mode</span><span class="p">:</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_REGISTER_MODE</span> <span class="o">&amp;&amp;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_REGISTER_MODE</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">auto</span><span class="dl">'</span><span class="p">)</span> <span class="p">?</span> <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">MODE_AUTOREGISTER</span> <span class="p">:</span> <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">MODE_NORMAL</span><span class="p">,</span>
        <span class="na">framework</span><span class="p">:</span> <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">KOA2</span><span class="p">,</span>
        <span class="nx">app</span><span class="p">,</span>
        <span class="nx">logger</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">service.name</span><span class="dl">'</span><span class="p">),</span>
        <span class="na">ctUrl</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_URL</span><span class="p">,</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LOCAL_URL</span><span class="p">,</span>
        <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_TOKEN</span><span class="p">,</span>
        <span class="na">active</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<p>Covering the arguments in detail:</p>

<ul>
<li>info: path to the JSON file that will be sent to Control Tower, containing the details about the endpoints exposed by this microservice.</li>
<li>swagger: path to the Swagger YAML file that will be sent to Control Tower, documenting the public endpoints exposed by this microservice.</li>
<li>mode: if set to <code>ctRegisterMicroservice.MODE_AUTOREGISTER</code> the Control Tower registration process will be automatically triggered when the Koa application server starts. Otherwise, use <code>ctRegisterMicroservice.MODE_NORMAL</code> if you want to register manually.</li>
<li>framework: <code>ctRegisterMicroservice.KOA2</code> or <code>ctRegisterMicroservice.KOA1</code>, depending on the Koa version your app uses.</li>
<li>app: Koa application instance</li>
<li>logger: <a href="https://github.com/quirkey/node-logger">Logger</a> instance.</li>
<li>name: name of the microservice to be provided to Control Tower as part of the registration process.</li>
<li>ctUrl: Control Tower URL.</li>
<li>url: URL within the internal network through which this microservice can be accessed.</li>
<li>token: Control Tower token to authenticate the registration requests</li>
<li>active: If set to <code>false</code> the microservice will be registered as disabled (not accessible). You should set this to <code>true</code> in most cases.</li>
</ul>

<p>This registration call usually takes place right after the microservice&#39;s start process has ended, and the corresponding web server is available. Keep in mind that the call above will trigger an HTTP request to Control Tower, which in turn will call the microservice&#39;s web server - so make sure the microservice&#39;s web server is up and running when you attempt to register it.</p>
<h3 id='requests-to-other-microservices'>Requests to other microservices</h3>
<p>Besides contacting Control Tower to register themselves, microservices also need to contact Control Tower to make requests to other microservices. </p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="c1">// Microservice call to another microservice's endpoint</span>
<span class="kd">const</span> <span class="nx">ctRegisterMicroservice</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">ct-register-microservice-node</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">tag1</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">tag2</span><span class="dl">'</span><span class="p">];</span>

<span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">requestToMicroservice</span><span class="p">({</span>
    <span class="na">uri</span><span class="p">:</span> <span class="s2">`/graph/dataset/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">/associate`</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">tags</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
<p>In this example, the dataset microservice makes a call to the <code>/graph/dataset/&lt;id&gt;/associate</code> endpoint to tag a dataset with the given tag list. This endpoint is implemented by the Graph microservice, but the request is actually handled by Control Tower. Taking a deeper look at the code that implements the call above, we learn a few things:</p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="c1">// Implementation of call to another microservice</span>

<span class="nx">requestToMicroservice</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">Adding authentication header </span><span class="dl">'</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">version</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_VERSION</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">version</span> <span class="o">=</span> <span class="s2">`/</span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_VERSION</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">version</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span> <span class="na">authentication</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">token</span> <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">application</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">app_key</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">application</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">application</span> <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">ctUrl</span> <span class="o">+</span> <span class="nx">version</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">requestPromise</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error to doing request</span><span class="dl">'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<p>As explained above, although the call is ultimately to another microservice, the request is sent to Control Tower, who is then responsible for issuing another internal request to the destination microservice, getting the reply from that call and passing it on to the microservice that initiated the process.</p>

<p>Another thing you&#39;ll notice is that this call depends on preexisting configuration stored in the <code>this.options</code> property. These configuration options are stored within the object during the Control Tower registration process, meaning you should not attempt to make a call to another microservice unless you have previously registered your microservice on Control Tower. Keep in mind that this is a restriction of this particular integration library, and not of Control Tower itself - a different implementation could do internal requests to microservices through Control Tower without being registered as a microservice.</p>

<p>In some scenarios, while developing, it&#39;s not practical to run all the microservices your logic depend on on your development computer. The <a href="developer.html#writing-end-to-end-tests">Writing end-to-end tests</a> section has some details about writing tests for your code, including how you can mock such calls, so you don&#39;t have to run the actual dependencies.</p>
<h2 id='docker'>Docker</h2>
<p>When deployed in a production environment, microservices will run in a <a href="https://www.docker.com/">Docker</a> container. As a microservice developer, you should include in your microservice the necessary configuration to run your application inside a container. This is done using a Dockerfile, and you can use the <a href="https://github.com/resource-watch/dataset/blob/develop/Dockerfile">Dataset microservice&#39;s Dockerfile</a> as an example of how one of these files looks like for a nodejs based microservice.</p>

<p>Its worth noting that these container are set up in a way that allows using them to both run the microservice itself, or their tests. This will be useful further ahead when we review the testing approach you should use when writing microservices.</p>
<h2 id='data-layer'>Data layer</h2>
<p>Many microservices require the ability to store data to perform their function. The RW API has several data storage tools available to you, in case you need to store information to run your service.</p>

<p><strong>Warning</strong>: microservices run on ephemeral containers managed by Kubernetes, and often in multiple parallel instances, so do not rely on storing data on the filesystem, unless you know there&#39;s something like a <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Kubernetes&#39; persistent volume</a> to back it up.</p>

<p>When accessing these tools, there are a few things you should keep in mind:</p>

<ul>
<li>Isolation is not guaranteed, meaning your microservice will have theoretical access to other microservice&#39;s data, and other microservices may access your data.</li>
<li>Despite having access to it, you should not manipulate other microservice&#39;s data directly at the data layer, unless there&#39;s a clear agreement between the involved microservices.</li>
<li>It&#39;s up to you to ensure logic level isolation of your data - for example, if you rely on an relational database, be sure to use a unique database name.</li>
<li>Access to the data layer is only available within the RW API cluster, which is why not all data storage tools have authentication enabled.</li>
</ul>

<p>Currently, the following data storage tools are available on the RW API cluster:</p>
<h3 id='mongodb-v3-6'>MongoDB v3.6</h3>
<p><a href="https://www.mongodb.com/">MongoDB</a> is the most frequently used data storage tool, as it supports schema-less document storage, thus making it easy to setup and run. When using MongoDB, be sure to give your collection an unique name, to avoid conflicts</p>

<p>To see an example of how to use MongoDB on a real-world microservice, check out the <a href="https://github.com/resource-watch/dataset/">Dataset microservice</a>.</p>
<h3 id='postgres-v9-6'>Postgres v9.6</h3>
<p>Use <a href="https://www.postgresql.org/">Postgres</a> if your application needs a relational database. Unlike other data storage tools, Postgres access to individual microservices is granted on a per-database basis.</p>

<p>To see an example of how to use Postgres on a real-world microservice, check out the <a href="https://github.com/resource-watch/resource-watch-manager/">Resource watch manager microservice</a> (written in Ruby on Rails).</p>
<h3 id='aws-elasticsearch-service-v7-7'>AWS Elasticsearch Service v7.7</h3>
<p>Use <a href="https://aws.amazon.com/elasticsearch-service/">AWS Elasticsearch Service</a> (powered by <a href="https://opendistro.github.io/for-elasticsearch/">Open Distro for Elasticsearch</a>) for search optimization or heterogeneous data storage with quick access.</p>

<p>To see an example of how to use Elasticsearch on a real-world microservice, check out the <a href="https://github.com/resource-watch/document-adapter/">Document dataset adapter microservice</a>.</p>
<h3 id='redis-v5-0'>Redis v5.0</h3>
<p><a href="https://redis.io/">Redis</a> is an in-memory data storage tool, and can also be used as a <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">pub-sub</a> messaging tool.</p>

<p>You can learn how to use Redis in your applications by looking at the code of the <a href="https://github.com/gfw-api/gfw-subscription-api">Subscriptions microservice</a>.</p>
<h3 id='neo4j-v2-0'>Neo4J v2.0</h3>
<p><a href="https://neo4j.com/">Neo4J</a> is a graph database used by <a href="https://github.com/resource-watch/graph-client/">Graph microservice</a> to build complex associations between different RW API resources.</p>
<h3 id='rabbitmq-v3-7'>RabbitMQ v3.7</h3>
<p><a href="https://www.rabbitmq.com/">RabbitMQ</a> is a message broker service, which is particularly useful when handling long, asynchronous operations. You can see an example of its usage on the <a href="https://github.com/resource-watch/doc-executor">Document microservice - Executor submodule</a> code base.</p>
<h3 id='cloud-services'>Cloud services</h3>
<p>Some microservices have data storage needs that are not covered by the applications described here (for example, file storage). In those scenarios, it&#39;s common to use cloud services (like AWS S3, for example), but do reach out to the broader RW API development team before implementing your solution.</p>
<h2 id='http-caching'>HTTP caching</h2>
<p>The RW API has a system-wide HTTP cache that you may use to cache your requests, improving scalability and response times. This cache is based on <a href="https://www.fastly.com/">Fastly</a>, and you can browse its documentation if you are looking for a specific detail on its behavior. For most common use cases, you just need to keep in mind the following:</p>

<ul>
<li>Only responses with codes 200, 203, 300 and 410 are cached, and the default cache TTL is 3 days.</li>
<li>GET responses for <code>/auth</code> endpoints are never cached.</li>
<li>GET responses for <code>/query</code> or <code>/fields</code> endpoints are cached for 2 days.</li>
<li>Your microservice can use the <code>cache</code> response header to tag a cache entry. This, in itself, has no functional impact. Example <a href="https://github.com/resource-watch/dataset/blob/47ad8b9509b97803d7f484549908e72ecaa98467/app/src/routes/api/v1/dataset.router.js#L396">here</a>.</li>
<li>Your microservice can use the <code>uncache</code> header to purge cache entries matching a given tag, as set in the previous point. Example <a href="https://github.com/resource-watch/dataset/blob/47ad8b9509b97803d7f484549908e72ecaa98467/app/src/routes/api/v1/dataset.router.js#L462">here</a>.</li>
</ul>

<p>These headers are then intercepted by the Control Tower <a href="https://github.com/resource-watch/control-tower/blob/dev/app/src/plugins/fastly-cache.js">Fastly integration plugin</a> which uses the Fastly API (through an integration nodejs library) to carry out the corresponding actions.</p>
<h2 id='logging'>Logging</h2>
<p>An important part of microservice operation is logging events as it processes requests. Many errors are only triggered during staging and production server execution, and without proper logging, there isn&#39;t a way to identify how it can be reproduced, so it can then be fixed.</p>

<p>Common development languages often come with either built-in or 3rd party logging libraries than make logging easier to handle. Current nodejs microservices use <a href="https://github.com/trentm/node-bunyan">Bunyan</a> to manage logs, which eases managing log destinations (stdout, file, etc) and log levels. Other libraries, for nodejs and other languages, offer similar functionality.</p>

<p>For microservice staging and production logs, the output channels should be <code>stdout</code> and <code>stderr</code>, the standard output streams you&#39;ll find on most OSs. When live, these, will seamlessly integrate with the infrastructure to which microservices will be deployed, and will allow for cluster-wide logging. </p>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">logger</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">Validating Dataset Update</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div>
<p>The example above logs that the validation process for input data associated with a dataset updated has been started. You&#39;ll notice that the <code>info()</code> function is called - this sets the logging level for this message. While different logging tools implement different strategies to differentiate logs, most microservices uses these 4 levels:</p>

<ul>
<li><code>debug</code>: use this whenever anything happens, that may or may not be relevant to have logged on a daily basis, but rather as a opt-in development and debug tool.</li>
<li><code>info</code>: use this for high-level expected actions and output that you&#39;d need to have available to you in case you need to investigate a production issue.</li>
<li><code>warn</code>: use this for situations where something unexpected happened, but that may not necessarily be irregular flows - for example, user originated errors.</li>
<li><code>error</code>: use this when the application failed and is no longer able to recover, or when an server-side error occurs.</li>
</ul>

<p>A common issue some developers have concerns logging errors. It&#39;s not uncommon to find microservices where all types of errors generate a <code>error</code> log entry. However, this actually produces a lot of noise, and make it hard to debug. Consider the following two scenarios when attempting to load a dataset by id:</p>

<ul>
<li>The dataset microservice queries the database, and the database cannot find a dataset matching that id, and the microservice returns a 404 HTTP response.</li>
<li>The dataset microservice queries the database, but the database is offline for whatever reason, and the microservice returns a 500 HTTP response.</li>
</ul>

<p>Both cases are, indeed, errors. However, the first one is not an application error - the microservice behaved as it should. In this scenario, logging this event should not involve an <code>error</code> level event, as nothing unexpected, from the application&#39;s point of view, happened: a user asked for something that does not exist, and the microservice handled that as it should.</p>

<p>On the second case, however, something really unexpected did happen - the microservice could not contact the database. This is an application level error, as we assume that our databases are always available for to microservices. This is an example scenario where a <code>error</code> logging line should be generated. Or, putting it in another way, only use <code>errors</code> logging for situations where a RW API developer should look into it.</p>

<p>Another best practice we recommend for log management is using an application-wide configuration value to define the logging level. This is prove extremely useful when you switch from your local development environment (where you may prefer the <code>debug</code> logging level for maximum detail) to production (where <code>warn</code> or <code>error</code> may be more reasonable). </p>

<p>When using Bunyan, logging levels are set <a href="https://github.com/resource-watch/dataset/blob/5d4b6d1a3b243f5ba985b444633c0f6acf78b35d/app/src/logger.js#L7">per stream</a>. Many microservices integrate the <a href="https://www.npmjs.com/package/config">Config</a> library at this stage, allowing you to have different values for <a href="https://github.com/resource-watch/dataset/blob/25ab6b6ac7b1c4618b3d4ae1690957b256bafca8/config/prod.json#L4">production</a>, <a href="https://github.com/resource-watch/dataset/blob/685a799f79f2441a129e4cf5cfaf3ed06ace5546/config/staging.json#L4">staging</a> or other environments. Config also allows you to <a href="https://github.com/resource-watch/dataset/blob/34d4b00fe06bd6d7c9b1dd25e043da4e820db653/config/custom-environment-variables.json#L12">override selected values with a environment variable</a>, typically <code>LOGGER_LEVEL</code>, which you may use, for example, to temporarily override the logging level on a particular environment without changing the predefined default values. </p>

<p>If you want to access your logging output for a microservice that&#39;s already deployed on either staging or production, you&#39;ll need access to <code>kubernetes</code> logging UI or CLI.</p>
<h2 id='testing'>Testing</h2>
<p>Testing code is important. And, as the developer of a RW API microservice, it&#39;s your responsibility to ensure that your code is bug free and easily extendable in the future. That means it should ship with a set of tests that can ensure, now and in the future, that it does what it&#39;s supposed to do. And the best way to do that is through testing.</p>

<p>If you are developing a new microservice or endpoint, it&#39;s expected that you provide a complete test suit for your code. In many cases, existing microservices will be a valuable source of examples you can copy and adapt to your needs. On occasion, you&#39;ll need to changes to endpoints that are not yet covered by tests. In those scenarios, we ask that add at least the tests to cover your modification. If you are feeling generous, and want to add tests that cover the endpoint&#39;s full functionality, you&#39;ll have our gratitude - test coverage for the RW API&#39;s endpoints is a work in progress, and not all endpoints have been reached just yet.</p>
<h3 id='writing-end-to-end-tests'>Writing end-to-end tests</h3>
<p>Most microservices rely, to varying degrees, on end-to-end tests. In the context of an HTTP based microservice, this means that tests are responsible for issuing an HTTP request to a running instance of your microservice, getting the response and validating its content. Tests should also handle things like mocking resources and isolation from outside world - we&#39;ll get to these in a moment.</p>

<blockquote>
<p>Example of a test from the dataset microservice</p>
</blockquote>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="nx">it</span><span class="p">(</span><span class="dl">'</span><span class="s1">Create a JSON dataset with data in the body should be successful</span><span class="dl">'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">dataset</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s2">`JSON Dataset - </span><span class="p">${</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">`</span><span class="p">,</span>
        <span class="na">application</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">forest-atlas</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">rw</span><span class="dl">'</span><span class="p">],</span>
        <span class="na">applicationConfig</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">forest-atlas</span><span class="dl">'</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="na">rw</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">foo</span><span class="p">:</span> <span class="dl">'</span><span class="s1">bar</span><span class="dl">'</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">connectorType</span><span class="p">:</span> <span class="dl">'</span><span class="s1">document</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">env</span><span class="p">:</span> <span class="dl">'</span><span class="s1">production</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">provider</span><span class="p">:</span> <span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">dataPath</span><span class="p">:</span> <span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">dataLastUpdated</span><span class="p">:</span> <span class="nx">timestamp</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">(),</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="na">b</span><span class="p">:</span> <span class="mi">2</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="na">a</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="na">b</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">nock</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_URL</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/v1/doc-datasets/json</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">connector</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">);</span>
            <span class="kd">const</span> <span class="nx">requestDataset</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">connector</span><span class="p">;</span>

            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">connectorType</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">connectorType</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">application</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">application</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">sources</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eql</span><span class="p">([]);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">connectorUrl</span><span class="dl">'</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="na">detail</span><span class="p">:</span> <span class="dl">'</span><span class="s1">Ok</span><span class="dl">'</span>
        <span class="p">});</span>

    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">requester</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">`/api/v1/dataset`</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span>
        <span class="nx">dataset</span><span class="p">,</span>
        <span class="na">loggedUser</span><span class="p">:</span> <span class="nx">USERS</span><span class="p">.</span><span class="nx">ADMIN</span>
    <span class="p">});</span>
    <span class="kd">const</span> <span class="nx">createdDataset</span> <span class="o">=</span> <span class="nx">deserializeDataset</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span><span class="dl">'</span><span class="s1">object</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">name</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">`JSON Dataset - </span><span class="p">${</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">connectorType</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="dl">'</span><span class="s1">document</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">provider</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="dl">'</span><span class="s1">json</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">connectorUrl</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">tableName</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">userId</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">USERS</span><span class="p">.</span><span class="nx">ADMIN</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">status</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="dl">'</span><span class="s1">pending</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">overwrite</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">applicationConfig</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">applicationConfig</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="dl">'</span><span class="s1">dataLastUpdated</span><span class="dl">'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">());</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">legend</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">.</span><span class="nx">instanceOf</span><span class="p">(</span><span class="nb">Object</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">clonedHost</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">.</span><span class="nx">instanceOf</span><span class="p">(</span><span class="nb">Object</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>Current nodejs based microservices rely on <a href="https://www.chaijs.com/">Chai</a> and <a href="https://mochajs.org/">Mocha</a> as testing libraries, and this code example shows one of the tests that validate the dataset creation process. The code block is relatively large, but the logic is simple:</p>

<ul>
<li>We craft a JSON object with the content of the HTTP POST body</li>
<li>As this endpoint needs to make a call to another microservice (through Control Tower), we use <a href="https://github.com/nock/nock">Nock</a> to mock that POST request to the <code>/v1/doc-datasets/json</code> endpoint. This way, your tests won&#39;t require actual running instances of Control Tower or other microservices to run.</li>
<li>We send the our previously crafted POST request to a running instance of our dataset microservice, along with a <code>loggedUser</code> spoof data.</li>
<li>We get the HTTP response, process it for easier handling, and proceed to validate that it&#39;s content is as expected.</li>
</ul>

<p>Different microservices and endpoint will have different requirements when it comes to testing, but the great majority of endpoints can be tested using simple variations of these steps. There are some additional considerations you should take into account when testing:</p>

<ul>
<li>The example above creates an actual dataset, meaning a MongoDB (or equivalent mocks) need to exist. For MongoDB specifically, our approach so far has been to use a real MongoDB instance, and running the tests on a separate database (´dataset-tests´ for example), aiming for isolation. Other microservices (for example, those relying on Elasticsearch) use mocks instead. Mocking usually leads to faster execution times, but can be troublesome to properly code. Use whichever alternative is best for you, and refer to the <a href="developer.html#data-layer">Data layer</a> section for examples of microservices that use (and test with) different tools.</li>
<li>Nock has a <a href="https://github.com/nock/nock#enabledisable-real-http-requests">feature that blocks all HTTP requests</a>, which is useful to ensure your code or tests are not relying on an external service without you being aware - just be sure to whitelist your own IP, otherwise the HTTP call your test makes to your microservice will fail too.</li>
<li>Tests must be idempotent, and execute without assuming order. For example, running a test that first tests an insert, and then using the inserted element to test a delete would be a bad practice. Instead, your insert test should clean up its data once it&#39;s done, and the delete test should prepopulate the database before actually trying to delete it. A corollary of this is that you should be able to run your tests multiple times, back-to-back, without that affecting the results.</li>
</ul>
<h3 id='test-coverage-metrics'>Test coverage metrics</h3>
<p>While not required, most microservices use <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a> tools to evaluate how much of your code base is actually being checked when the test suite is executed. Nodejs based microservices frequently use <a href="https://www.npmjs.com/package/nyc">NYC</a> and <a href="https://istanbul.js.org/">Istanbul</a> for this purpose, in case you are looking for a recommendation.</p>
<h3 id='running-your-tests-using-docker-compose'>Running your tests using docker compose</h3>
<p>The previous section covers an example of how a test looks like. Depending on your microservice technology stack, you have different ways of running your tests - in the case of the Dataset microservice, tests are executed using <a href="https://yarnpkg.com/">yarn</a>. </p>

<p>However, to standardise test execution, you should also create a <a href="https://docs.docker.com/compose/">docker compose</a> file that runs your tests (and their dependencies). This docker compose configuration should use the <a href="developer.html#docker">existing docker file</a> set up previously, unless that&#39;s not possible.</p>

<p>Here&#39;s an example of <a href="https://github.com/resource-watch/dataset/blob/ab23e379362680e9899ac8f191589988f0b7c1cd/docker-compose-test.yml">one of these files</a>. These will be particularly useful down the line, but also convenient for running tests locally.</p>

<p>For convenience, microservices commonly have a <a href="https://github.com/resource-watch/dataset/blob/ab23e37936/dataset.sh#L8">one line CLI command</a> that allows running tests using the docker compose configuration you provide. These are particularly useful for other developers to run your tests without having to manually set up the associated dependencies.</p>
<h3 id='ci-cd-travis-and-code-climate'>CI/CD, Travis and Code Climate</h3>
<p>Assuming you are hosting your microservice code on a service like Github, then you may benefit from its integration with <a href="https://en.wikipedia.org/wiki/CI/CD">CI/CD</a> tools. There are multiple options in this space, and they mostly offer the same core functionality, but our preference so far has been to use <a href="https://travis-ci.org/">Travis</a>. In a nutshell, you can configure Travis to run your tests every time you push a new commit to a Github pull request. Tests will run on Travis&#39; servers, and if they fail, you will get a message on your pull request warning you about this.</p>

<p>For full details on Travis and its features, how to configure it, what alternatives are there, and their pros and cons, please refer to your favourite search engine. If you are just want the basic, &quot;it just works&quot; configuration, <a href="https://github.com/resource-watch/dataset/blob/cd55ff83695266ffae58471569fc3c16b2f1adf2/.travis.yml#L10">this file from the Dataset microservice</a> will have most of what you&#39;ll need.</p>

<p>Apart from running your tests, Travis also integrates with a service called <a href="https://codeclimate.com/">Code Climate</a> which analyses your code and looks for potentially problematic bits and suggests you fix them. More often than not, we just rely on another functionality offered by Code Climate - <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a>. This allows you to easily monitor how your pull request influences code coverage - for example, you can set up an alarm that warns you in case your pull request decreases your code coverage, which may indicate that you added more code than you tested.</p>

<p>Most microservices will display a test status and code coverage badges on their README, as a way to display if the tests are passing, and a rough estimation of how broad the test coverage is.</p>
<h3 id='smoke-testing'>Smoke testing</h3>
<p>Besides the test tools covered above, which are used to validate that your code changes work as designed, there is also a smoke test tool in place, that periodically issues a request to selected RW API endpoints and validates that the response match an expected preconfigured value. These tests are not used to validate functionality, but rather availability - if something goes wrong, a human is notified that the RW API is not working as it should, and that this is potentially affecting users. </p>

<p>If you believe your microservice implements a mission-critical endpoint that would merit one of these tests, please reach out to the RW API team.</p>
<h2 id='deploying-your-microservice'>Deploying your microservice</h2><h3 id='jenkins'>Jenkins</h3>
<p>Microservice deployment to the Kubernetes clusters is done using <a href="https://www.jenkins.io/">Jenkins</a>. The actual deployment process is configurable using a <a href="https://github.com/resource-watch/dataset/blob/develop/Jenkinsfile">Jenkinsfile</a> script written in <a href="https://groovy-lang.org/">Groovy</a>. Most microservices use the same file, as the logic in it is flexible enough to accommodate most scenarios.</p>

<p>In a nutshell, this Jenkinsfile will:</p>

<ul>
<li>Build a docker image using the Docker file contained in your microservice.</li>
<li>Uses the included docker compose configuration to run your tests. If the tests fail, the process is aborted at this stage</li>
<li>Push the generated docker image to <a href="https://hub.docker.com/">dockerhub</a></li>
<li>Depending on the git branch and the Jenkinsfile content, some of the following actions may take place:

<ul>
<li>If deploying from the <code>dev</code> branch, it will push the docker image to the dev kubernetes cluster </li>
<li>If deploying from the <code>develop</code> or <code>staging</code> branches, it will push the docker image to the staging kubernetes cluster </li>
<li>If deploying from the <code>master</code> or <code>production</code> branches branch, you will get a confirmation input. If you confirm, it will push the docker image to the production kubernetes cluster </li>
<li>Any other branches are ignored.</li>
</ul></li>
</ul>

<p><strong>A note on branches</strong>: an old branching scheme you may still find on some microservices relied on <code>master</code> + <code>develop</code> branches, but it&#39;s gradually being replaced by a scheme that uses <code>dev</code>, <code>staging</code> and <code>production</code>. All repos use one scheme or the other, but not both simultaneously, and the Jenkinsfile will reflect that.</p>

<p>At the beginning of each deploy process, you may also see an confirmation input that, if accepted, will redeploy the kubernetes configuration contained in the microservice code repository to the respective kubernetes cluster: <code>develop</code> branch to the staging cluster, <code>master</code> branch to the production cluster.</p>

<p>One thing worth noting is that the docker images generated using this method are publicly available on dockerhub. Be careful not to store any sensitive data in them, as it will be available to anyone.</p>
<h4 id='getting-access-to-jenkins'>Getting access to Jenkins</h4>
<p>Each environment (<code>dev</code>, <code>staging</code>, <code>production</code>) has its own Jenkins server:</p>

<ul>
<li><a href="https://jenkins.aws-dev.resourcewatch.org">Jenkins for the dev environment</a></li>
<li><a href="https://jenkins.aws-staging.resourcewatch.org">Jenkins for the staging environment</a></li>
<li><a href="https://jenkins.aws-prod.resourcewatch.org">Jenkins for the production environment</a></li>
</ul>

<p>If you need an account in one of these environments (for example to approve a deployment in production), contact ethan.roday@wri.org.</p>
<h3 id='kubernetes-configuration'>Kubernetes configuration</h3>
<p>Most microservice have a <a href="https://github.com/resource-watch/dataset/tree/develop/k8s">Kubernetes configuration folder</a>, typically containing 3 folders:</p>

<ul>
<li><code>production</code> contains files that will be applied when deploying the <code>master</code> branch to the production cluster</li>
<li><code>staging</code> contains files that will be applied when deploying the <code>develop</code> branch to the production cluster</li>
<li><code>services</code> contains files that will be applied when deploying either branches to their respective cluster.</li>
</ul>

<p>Note that these settings are only applied if you opt in to it, by interacting with the input request that is displayed on Jenkins at the very beginning of the deployment process.</p>
<h2 id='documentation'>Documentation</h2><h3 id='readme'>README</h3>
<p>Here are some &#39;do&#39; and &#39;do not&#39; you should take into account when writing the README.md for your microservice.</p>

<p>Do:</p>

<ul>
<li>Add the name of your microservice, along with a high level, short description of what it does.</li>
<li>Identify the technical dependencies. This should include:

<ul>
<li>Programming language</li>
<li>Main framework or language-specific tools used</li>
<li>Data layer dependencies or other applications, including version numbers</li>
<li>Dependencies on other microservices</li>
</ul></li>
<li>Describe how to get your microservice up and running for development purposes (at least for the operating system you are currently using, but you get extra &quot;thank you&quot;s if you add details for other OSs)</li>
<li>Describe how to run your tests</li>
<li>Describe if and which configuration variables exist, and their behavior.</li>
<li>Document implementation details, software development architectural decisions, etc</li>
<li>Use English.</li>
</ul>

<p>Do not:</p>

<ul>
<li>Document in detail how to set up dependencies on 3rd party applications (for example, don&#39;t provide installation instruction for a database server, just mention it&#39;s a dependency, and assume your fellow developer will figure out how to set it up on their system).</li>
<li>Include a license text - you may mention it, but add the actual text on a separate file, to keep the README file concise.</li>
<li>Assume the reader has vast experience in developing for the RW API, in the language your microservice is coded on, or using its dependencies or libraries</li>
<li>Document endpoint behavior - that goes elsewhere.</li>
</ul>

<p>Overall, the README should be targeted at developers that may need to run, test and debug your code.</p>
<h3 id='functional-documentation'>Functional documentation</h3>
<p>Documentation describing the business logic implemented by your microservice should go in the <a href="reference.html">RW API reference documentation</a> page. The documentation is available <a href="https://github.com/resource-watch/doc-api/">on this Github repository</a> and its README includes instructions on how to use it and contribute.</p>

<p>Documentation is a key component of a successful API, so when altering public-facing behavior on the RW API, you must update the documentation accordingly, so that RW API users out there can be aware of the changes you made.</p>
<h2 id='code-styling'>Code styling</h2>
<p>As a way to help RW API developers collaborate, most microservices include a <a href="https://en.wikipedia.org/wiki/Lint_(software)">linter</a> tool and ruleset to promote, as much as possible, a common set of rules for the way code is structured.</p>

<p>For microservices written in nodejs, this is achieved using <a href="https://eslint.org/">Eslint</a> with <a href="https://github.com/resource-watch/dataset/blob/develop/.eslintrc.yml">this configuration file</a>.</p>

<p>For ruby-based microservices, you can use <a href="https://github.com/rubocop-hq/rubocop">Rubocop</a> along with <a href="https://github.com/resource-watch/resource-watch-manager/blob/develop/.rubocop.yml">this configuration file</a>.</p>

<p>Most microservices will also include a <a href="https://github.com/resource-watch/dataset/blob/develop/.editorconfig">.editorconfig</a> file - you can learn more about there <a href="https://editorconfig.org/">here</a>.</p>
<h1 id='endpoints'>Endpoints</h1>
<p>This section of the documentation refers to endpoints that can only be used for the purposes of development. These endpoints can only be called by other micro services via Control Tower.</p>
<h2 id='finding-users-by-ids'>Finding users by ids</h2>
<p>To retrieve the information of multiple users by ids, use the <code>/auth/user/find-by-ids</code> endpoint.</p>

<p>This endpoint requires authentication, and can only be called from another micro service.</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code><span class="c"># retrieve info for multiple users with the given ids</span>
curl <span class="nt">-X</span> POST https://api.resourcewatch.org/auth/user/find-by-ids <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>  <span class="nt">-d</span> <span class="se">\</span>
<span class="s1">'{
    "ids": [
        "0706f055b929453eb1547392123ae99e",
        "0c630aeb81464fcca9bebe5adcb731c8",
    ]
}'</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>    <span class="o">{</span>
        <span class="s2">"data"</span>: <span class="o">[</span>
            <span class="o">{</span>
                <span class="s2">"provider"</span>: <span class="s2">"local"</span>,
                <span class="s2">"role"</span>: <span class="s2">"USER"</span>,
                <span class="s2">"_id"</span>: <span class="s2">"0706f055b929453eb1547392123ae99e"</span>,
                <span class="s2">"email"</span>: <span class="s2">"example@user.com"</span>,
                <span class="s2">"createdAt"</span>: <span class="s2">"2016-08-22T11:48:51.163Z"</span>,
                <span class="s2">"extraUserData"</span>: <span class="o">{</span>
                    <span class="s2">"apps"</span>: <span class="o">[</span>
                        <span class="s2">"rw"</span>,
                        <span class="s2">"gfw"</span>
                    <span class="o">]</span>
                <span class="o">}</span>,
                <span class="s2">"updatedAt"</span>: <span class="s2">"2019-12-18T15:59:57.333Z"</span>
            <span class="o">}</span>,
            <span class="o">{</span>
                <span class="s2">"provider"</span>: <span class="s2">"local"</span>,
                <span class="s2">"role"</span>: <span class="s2">"ADMIN"</span>,
                <span class="s2">"_id"</span>: <span class="s2">"0c630aeb81464fcca9bebe5adcb731c8"</span>,
                <span class="s2">"email"</span>: <span class="s2">"example2@user.com"</span>,
                <span class="s2">"createdAt"</span>: <span class="s2">"2016-08-22T11:48:51.163Z"</span>,
                <span class="s2">"extraUserData"</span>: <span class="o">{</span>
                    <span class="s2">"apps"</span>: <span class="o">[</span>
                        <span class="s2">"rw"</span>,
                        <span class="s2">"gfw"</span>,
                        <span class="s2">"prep"</span>,
                        <span class="s2">"aqueduct"</span>,
                        <span class="s2">"forest-atlas"</span>,
                        <span class="s2">"data4sdgs"</span>,
                        <span class="s2">"gfw-climate"</span>,
                        <span class="s2">"gfw-pro"</span>,
                        <span class="s2">"ghg-gdp"</span>
                    <span class="o">]</span>
                <span class="o">}</span>,
                <span class="s2">"updatedAt"</span>: <span class="s2">"2019-12-18T15:59:57.333Z"</span>
            <span class="o">}</span>
        <span class="o">]</span>
    <span class="o">}</span>
</code></pre></div><h1 id='microservice-reference'>Microservice reference</h1>
<p>This document should give developers a bird&#39;s eye view of existing microservices, their status and resources, organized by namespace.</p>
<h2 id='core'>Core</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>arcgis</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/adapter-arcgis">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/adapter-arcgis"><img src="https://travis-ci.com/resource-watch/adapter-arcgis.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/adapter-arcgis/test_coverage"><img src="https://api.codeclimate.com/v1/badges/682efc4cf55c6a795782/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>bigquery</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/adapter-bigquery">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/adapter-bigquery"><img src="https://travis-ci.com/resource-watch/adapter-bigquery.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/adapter-bigquery/test_coverage"><img src="https://api.codeclimate.com/v1/badges/383b48f860c6578ce531/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>carto</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/rw-adapter-carto">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/rw-adapter-carto"><img src="https://travis-ci.com/resource-watch/rw-adapter-carto.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/rw-adapter-carto/test_coverage"><img src="https://api.codeclimate.com/v1/badges/0afec809bb5b7e1d37e7/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>control-tower</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/control-tower">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/control-tower"><img src="https://travis-ci.com/resource-watch/control-tower.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/control-tower/test_coverage"><img src="https://api.codeclimate.com/v1/badges/6998e7a532fb2d138ca3/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>converter</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/converter">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/converter"><img src="https://travis-ci.com/resource-watch/converter.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/converter/test_coverage"><img src="https://api.codeclimate.com/v1/badges/b67e263c0e624c8bb50f/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>dataset</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/dataset/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/dataset"><img src="https://travis-ci.com/resource-watch/dataset.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/dataset/test_coverage"><img src="https://api.codeclimate.com/v1/badges/6e90d8ae68d28c916a5c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>doc-executor</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/doc-executor">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/doc-executor"><img src="https://travis-ci.com/resource-watch/doc-executor.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/doc-executor/test_coverage"><img src="https://api.codeclimate.com/v1/badges/e738a794d9771d51f292/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>doc-orchestrator</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/doc-orchestrator/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/doc-orchestrator"><img src="https://travis-ci.com/resource-watch/doc-orchestrator.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/doc-orchestrator/test_coverage"><img src="https://api.codeclimate.com/v1/badges/9d531e64d694f0e77d86/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>doc-writer</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/doc-writer/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/doc-writer"><img src="https://travis-ci.com/resource-watch/doc-writer.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/doc-writer/test_coverage"><img src="https://api.codeclimate.com/v1/badges/51973ae3d8b03163522d/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>document</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/document-adapter/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/document-adapter"><img src="https://travis-ci.com/resource-watch/document-adapter.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/document-adapter/test_coverage"><img src="https://api.codeclimate.com/v1/badges/381fe72ebbdaaeb9aff4/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fires summary</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fires-summary-stats/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/fires-summary-stats"><img src="https://travis-ci.com/gfw-api/fires-summary-stats.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fires-summary-stats/test_coverage"><img src="https://api.codeclimate.com/v1/badges/991ade88cf1913c0ecd9/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gee</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/adapter-earth-engine">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/adapter-earth-engine"><img src="https://travis-ci.com/resource-watch/adapter-earth-engine.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/adapter-earth-engine/test_coverage"><img src="https://api.codeclimate.com/v1/badges/b221d818e0e99f94d0c8/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gee-tiles</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/gee-tiles">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/gee-tiles"><img src="https://travis-ci.com/resource-watch/gee-tiles.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/gee-tiles/test_coverage"><img src="https://api.codeclimate.com/v1/badges/6c8dd3205ab1cb4a0073/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>geostore</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-geostore-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-geostore-api"><img src="https://travis-ci.com/gfw-api/gfw-geostore-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-geostore-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/896da4f09a0ebb049753/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>graph-client</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/graph-client/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/graph-client"><img src="https://travis-ci.com/resource-watch/graph-client.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/graph-client/test_coverage"><img src="https://api.codeclimate.com/v1/badges/5fbe8f9c23d81587d091/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>layer</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/layer">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/layer"><img src="https://travis-ci.com/resource-watch/layer.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/layer/test_coverage"><img src="https://api.codeclimate.com/v1/badges/31c04ea387e28ef9ada7/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>metadata</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/rw_metadata">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/rw_metadata"><img src="https://travis-ci.com/resource-watch/rw_metadata.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/rw_metadata/test_coverage"><img src="https://api.codeclimate.com/v1/badges/93b1d3c022b33c438ce1/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>mail</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-mail-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-mail-api"><img src="https://travis-ci.com/gfw-api/gfw-mail-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-mail-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/a4f13ba330b5d5573d7a/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>query</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/query/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/query"><img src="https://travis-ci.com/resource-watch/query.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/query/test_coverage"><img src="https://api.codeclimate.com/v1/badges/3e6b21174a2e8fe2192c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>rw-lp</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/rw-lp">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>task-async</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/task-executor">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>vocabulary</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/vocabulary-tag/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/vocabulary-tag"><img src="https://travis-ci.com/resource-watch/vocabulary-tag.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/vocabulary-tag/test_coverage"><img src="https://api.codeclimate.com/v1/badges/89f70e66993b8524fd09/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>webshot</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/webshot">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/webshot"><img src="https://travis-ci.com/resource-watch/webshot.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/webshot/test_coverage"><img src="https://api.codeclimate.com/v1/badges/e361eed538fcc656c7cd/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>widget</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/widget">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/widget"><img src="https://travis-ci.com/resource-watch/widget.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/widget/test_coverage"><img src="https://api.codeclimate.com/v1/badges/a5b0be0d7e79db309b30/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>
<h2 id='gfw'>GFW</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>analysis-gee</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-analysis-gee">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-analysis-gee"><img src="https://travis-ci.com/gfw-api/gfw-analysis-gee.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-analysis-gee/test_coverage"><img src="https://api.codeclimate.com/v1/badges/2d03ef51b43e72eae7e1/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>arcgis-proxy</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/arcgis-proxy">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/arcgis-proxy"><img src="https://travis-ci.com/gfw-api/arcgis-proxy.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/arcgis-proxy/test_coverage"><img src="https://api.codeclimate.com/v1/badges/cccb3b1b648ce4686ca5/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>area</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-area">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-area"><img src="https://travis-ci.com/gfw-api/gfw-area.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-area/test_coverage"><img src="https://api.codeclimate.com/v1/badges/d4eaa98d51c79d83159b/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>forest-change</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/forest-change-analysis-elastic">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/forest-change-analysis-elastic"><img src="https://travis-ci.com/gfw-api/forest-change-analysis-elastic.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/forest-change-analysis-elastic/test_coverage"><img src="https://api.codeclimate.com/v1/badges/d86e27f2918b5cb53fdb/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-forma</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-forma-alerts-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-forma-alerts-api"><img src="https://travis-ci.com/gfw-api/gfw-forma-alerts-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-forma-alerts-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/38c6573628d854533ee9/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-guira</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-guira-loss-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-guira-loss-api"><img src="https://travis-ci.com/gfw-api/gfw-guira-loss-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-guira-loss-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/bd10718ad3aa55db6e7a/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-ogr</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-ogr-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-ogr-api"><img src="https://travis-ci.com/gfw-api/gfw-ogr-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-ogr-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/a818cbdf6e1cb49d6256/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-prodes</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-prodes-loss-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-prodes-loss-api"><img src="https://travis-ci.com/gfw-api/gfw-prodes-loss-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-prodes-loss-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/e683fe0cb0dc0b7cab57/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-umd</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-umd-forest-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-umd-forest-api"><img src="https://travis-ci.com/gfw-api/gfw-umd-forest-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-umd-forest-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/3b10b3f9b97cb5e275ac/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-user</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-user-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-user-api"><img src="https://travis-ci.com/gfw-api/gfw-user-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-user-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/9f3238f6631f9c5e4ad7/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gs-pro-config</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gs-pro-config/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gs-pro-config"><img src="https://travis-ci.com/gfw-api/gs-pro-config.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gs-pro-config/test_coverage"><img src="https://api.codeclimate.com/v1/badges/4a6bd3e90a49a0a6000c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>glad-analysis-athena</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/glad-analysis-tiled">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/glad-analysis-tiled"><img src="https://travis-ci.com/gfw-api/glad-analysis-tiled.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/glad-analysis-tiled/test_coverage"><img src="https://api.codeclimate.com/v1/badges/55617d7d21d384ce68e6/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>high-res</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/high-res">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/high-res"><img src="https://travis-ci.com/gfw-api/high-res.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/high-res/test_coverage"><img src="https://api.codeclimate.com/v1/badges/8a00bada07dadb6aa23a/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>imazon</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-imazon-alerts-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-imazon-alerts-api"><img src="https://travis-ci.com/gfw-api/gfw-imazon-alerts-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-imazon-alerts-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/7c1d35d3f2ddb21fa6a4/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>quicc</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-quicc-alerts-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-quicc-alerts-api"><img src="https://travis-ci.com/gfw-api/gfw-quicc-alerts-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-quicc-alerts-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/ec043e87f221b1d8a547/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>story</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-story-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-story-api"><img src="https://travis-ci.com/gfw-api/gfw-story-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-story-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/719013c600d29a695000/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>subscriptions</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-subscription-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-subscription-api"><img src="https://travis-ci.com/gfw-api/gfw-subscription-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-subscription-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/fd35453ead111fbb221c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>true-color-tiles</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/true-color-tiles">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/true-color-tiles"><img src="https://travis-ci.com/gfw-api/true-color-tiles.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/true-color-tiles/test_coverage"><img src="https://api.codeclimate.com/v1/badges/90a8a96a1b064267f42d/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>viirs-fires</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-viirs-fires-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-viirs-fires-api"><img src="https://travis-ci.com/gfw-api/gfw-viirs-fires-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-viirs-fires-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/5978e5b572f6194cbe42/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>
<h2 id='fw'>FW</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>forest-watcher-api</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/forest-watcher">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/forest-watcher"><img src="https://travis-ci.com/gfw-api/forest-watcher.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/forest-watcher/test_coverage"><img src="https://api.codeclimate.com/v1/badges/dfce5cd3c6aa92bf95ea/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>forms</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-forms-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/gfw-forms-api"><img src="https://travis-ci.com/gfw-api/gfw-forms-api.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-forms-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/fead108699d985f0b266/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fw-alerts</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fw-alerts">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/fw-alerts"><img src="https://travis-ci.com/gfw-api/fw-alerts.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fw-alerts/test_coverage"><img src="https://api.codeclimate.com/v1/badges/40d4b1e823a36f2041a4/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fw-contextual-layers</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fw-contextual-layers">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/fw-contextual-layers"><img src="https://travis-ci.com/gfw-api/fw-contextual-layers.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fw-contextual-layers/test_coverage"><img src="https://api.codeclimate.com/v1/badges/c1954d5df380ff14aae1/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fw-teams</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fw-teams">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/gfw-api/fw-teams"><img src="https://travis-ci.com/gfw-api/fw-teams.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fw-teams/test_coverage"><img src="https://api.codeclimate.com/v1/badges/67ef5c9f03336a7e5608/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>
<h2 id='aqueduct'>Aqueduct</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>aqueduct-analysis</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/aqueduct-analysis-microservice">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/aqueduct-analysis-microservice"><img src="https://travis-ci.com/resource-watch/aqueduct-analysis-microservice.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/aqueduct-analysis-microservice/test_coverage"><img src="https://api.codeclimate.com/v1/badges/412dbad07a559dbd4105/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>
<h2 id='prep'>PREP</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>nexgddp</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-nexgddp">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/prep-nexgddp"><img src="https://travis-ci.com/resource-watch/prep-nexgddp.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/prep-nexgddp/test_coverage"><img src="https://api.codeclimate.com/v1/badges/b9bac026b8eb531a7e19/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>prep-api</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/prep-api"><img src="https://travis-ci.com/resource-watch/prep-api.svg?branch=master" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/prep-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/59331ed7504c0e00db4c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>prep-app</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-app">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>prep-manager</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-manager">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>proxy</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/proxy">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/proxy"><img src="https://travis-ci.com/resource-watch/proxy.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/proxy/test_coverage"><img src="https://api.codeclimate.com/v1/badges/2d6843b256ec3549b0b5/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>
<h2 id='climate-watch'>Climate Watch</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>Climate Watch Flagship</td>
<td style="text-align: center"><a href="https://github.com/Vizzuality/climate-watch">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch India Platform</td>
<td style="text-align: center"><a href="https://github.com/ClimateWatch-Vizzuality/india-platform">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch Indonesia Platform</td>
<td style="text-align: center"><a href="https://github.com/ClimateWatch-Vizzuality/indonesia-platform">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch South Africa Platform</td>
<td style="text-align: center"><a href="https://github.com/ClimateWatch-Vizzuality/south-africa-platform">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch: Emissions Scenario Portal</td>
<td style="text-align: center"><a href="https://github.com/Vizzuality/emissions-scenario-portal">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
</tbody></table>
<h2 id='rw'>RW</h2>
<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>resource-watch-manager</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/resource-watch-manager/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.com/resource-watch/resource-watch-manager"><img src="https://travis-ci.com/resource-watch/resource-watch-manager.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/resource-watch-manager/test_coverage"><img src="https://api.codeclimate.com/v1/badges/cc3b209e57a896fe6d7c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>
<h1 id='api-smoke-tests'>API Smoke Tests</h1>
<p>This chapter covers the existing API Smoke Tests, including instructions on how to manage existing tests and create new ones.</p>

<p>The API Smoke Tests are implemented using Canaries provided by AWS Synthetics <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries.html">(docs here)</a>.</p>
<h2 id='template-for-smoke-tests'>Template for smoke tests</h2>
<blockquote>
<p>Template for an AWS Synthetics Canary</p>
</blockquote>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="kd">const</span> <span class="nx">synthetics</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">Synthetics</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">SyntheticsLogger</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">https</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">apiCanaryBlueprint</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

  <span class="kd">const</span> <span class="nx">verifyRequest</span> <span class="o">=</span> <span class="k">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">requestOption</span><span class="p">,</span> <span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Prep request</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">"</span><span class="s2">Making request with options: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">requestOption</span><span class="p">));</span>
      <span class="kd">let</span> <span class="nx">req</span> <span class="o">=</span> <span class="p">(</span><span class="nx">requestOption</span><span class="p">.</span><span class="nx">port</span> <span class="o">===</span> <span class="mi">443</span><span class="p">)</span> <span class="p">?</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestOption</span><span class="p">)</span> <span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestOption</span><span class="p">);</span>

      <span class="c1">// POST body data</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span> <span class="p">}</span>

      <span class="c1">// Handle response</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">response</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Status Code: </span><span class="p">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

        <span class="c1">// Assert the status code returned</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="dl">"</span><span class="s2">Failed: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">requestOption</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> with status code </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Grab body chunks and piece returned body together</span>
        <span class="kd">let</span> <span class="nx">body</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="p">});</span>

        <span class="c1">// Resolve providing the returned body</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">)));</span>
      <span class="p">});</span>

      <span class="c1">// Reject on error</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Build request options</span>
  <span class="kd">let</span> <span class="nx">requestOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">hostname</span><span class="p">:</span> <span class="dl">"</span><span class="s2">api.resourcewatch.org</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="dl">"</span><span class="s2">/v1/dataset</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">'</span><span class="s1">User-Agent</span><span class="dl">'</span><span class="p">:</span> <span class="nx">synthetics</span><span class="p">.</span><span class="nx">getCanaryUserAgentString</span><span class="p">(),</span>
      <span class="dl">'</span><span class="s1">Content-Type</span><span class="dl">'</span><span class="p">:</span> <span class="dl">'</span><span class="s1">application/json</span><span class="dl">'</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="c1">// Find and use secret for auth token</span>
  <span class="kd">const</span> <span class="nx">secretsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">SecretsManager</span><span class="p">();</span>
  <span class="k">await</span> <span class="nx">secretsManager</span><span class="p">.</span><span class="nx">getSecretValue</span><span class="p">({</span> <span class="na">SecretId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">gfw-api/token</span><span class="dl">"</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="dl">'</span><span class="s1">Authorization</span><span class="dl">'</span><span class="p">]</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">Bearer </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">SecretString</span><span class="dl">"</span><span class="p">])[</span><span class="dl">"</span><span class="s2">token</span><span class="dl">"</span><span class="p">];</span>
  <span class="p">}).</span><span class="nx">promise</span><span class="p">();</span>

  <span class="c1">// Find and use secret for hostname</span>
  <span class="k">await</span> <span class="nx">secretsManager</span><span class="p">.</span><span class="nx">getSecretValue</span><span class="p">({</span> <span class="na">SecretId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">wri-api/smoke-tests-host</span><span class="dl">"</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="dl">"</span><span class="s2">SecretString</span><span class="dl">"</span><span class="p">])[</span><span class="dl">"</span><span class="s2">smoke-tests-host</span><span class="dl">"</span><span class="p">];</span>
  <span class="p">}).</span><span class="nx">promise</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">verifyRequest</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>

  <span class="c1">// Change needed request options</span>
  <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">;</span>
  <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">/v1/dataset/</span><span class="dl">"</span><span class="o">+</span><span class="nx">id</span><span class="p">;</span>

  <span class="c1">// Make second request</span>
  <span class="k">await</span> <span class="nx">verifyRequest</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">await</span> <span class="nx">apiCanaryBlueprint</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
<p>New tests should be based on the template displayed on the side, in order to take advantage of the configurations already in place.</p>

<p>Tests can execute multiple requests, but please minimize the number of interactions with databases to avoid creating junk data (for this reason, smoke testing POST, PATCH and DELETE endpoints is not recommended).</p>

<p>Another thing to notice is the usage of AWS secrets for storing a token to execute the request (<code>gfw-api/token</code>), as well as the hostname where the test will be executed (<code>wri-api/smoke-tests-host</code>).</p>

<p>The template on the side executes a GET request to <code>/v1/dataset</code>, grabs the first ID in the response data and executes a second GET request to the <code>/v1/dataset/:id</code> endpoint.</p>

<p><em>The test will pass if there are no exceptions thrown or promise rejections during the execution of the test. For the example on the side, the test will fail if any of the requests performed returns a status code that is not 200.</em></p>
<h2 id='things-to-pay-attention'>Things to pay attention</h2><h3 id='use-a-user-to-run-the-tests'>Use a user to run the tests</h3>
<p>Please ensure that all tests are ran using a token for a user <strong>which was specifically created for running the tests</strong>. Also, it goes without saying, please don&#39;t share either the token or the credentials for the user running the tests with anyone.</p>
<h3 id='always-configure-alarms-for-the-smoke-tests'>Always configure alarms for the smoke tests</h3>
<p>Smoke tests by default are created without an associated alarm. When managing or creating smoke tests, <strong>please ensure that each test has a unique alarm associated to it</strong>.</p>

<p>Also, <strong>please ensure that the created alarm has an action defined to notify someone in case of failure of a test</strong>.</p>
<h2 id='running-smoke-tests-locally'>Running smoke tests locally</h2>
<blockquote>
<p>Step 5 (before):</p>
</blockquote>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">await</span> <span class="nx">apiCanaryBlueprint</span><span class="p">();</span>
<span class="p">};</span>
</code></pre></div>
<blockquote>
<p>Step 5 (after):</p>
</blockquote>
<div class="highlight"><pre class="highlight javascript tab-javascript"><code><span class="nx">apiCanaryBlueprint</span><span class="p">();</span>
</code></pre></div>
<p>In order to run smoke tests on your local machine for testing the script, some modifications need to be done:</p>

<ol>
<li>Copy the smoke test script into a file in your local machine (in this case, we&#39;re going to assume the name the file as <code>index.js</code>).</li>
<li>Comment out any references to the <code>Synthetics</code> NPM package, which is only available for internal usage in the canary script.</li>
<li>Replace all <code>log.info</code> references (or any other method of the <code>log</code> package) with <code>console.log</code> and comment out the usage of the <code>SyntheticsLogger</code> NPM package.</li>
<li>Comment out references to the usage of AWS secrets and to the <code>aws-sdk</code> NPM package.</li>
<li>Replace the last lines of the script (see on the side).</li>
</ol>

<p>After these changes, you should be able to run the script locally using <code>node index.js</code>. Remember that any exception or error thrown will cause the test to fail, otherwise the test will be considered a pass. If you want to explicitly fail the test if some assertion is not valid, you can throw a new Error with a message for debugging.</p>

<p>Before updating the script once again in AWS Synthetics, <strong>don&#39;t forget to revert ALL the changes (just follow the steps in the reverse order)</strong>.</p>
<h1 id='query-transformations'>Query transformations</h1>
<p><strong>While the WRI API aims to make the query interface as broad and transparent as possible, some of the querying options described below will not be available for specific dataset providers, depending on this API&#39;s implementation or limitations on the actual data provider&#39;s side.</strong></p>

<p>Additionally to provider-specific limitations, every SQL query is transformed by <a href="https://github.com/resource-watch/sql2json">the <code>sql2json</code> microservice</a>, also maintained as <a href="https://www.npmjs.com/package/sql2json">NPM package</a>. There is a first conversion from SQL to JSON, and then from JSON to a SQL syntax that is compatible with <a href="https://opendistro.github.io/for-elasticsearch-docs/docs/sql/">Open Distro for Elasticsearch SQL syntax</a>.</p>

<p>You can read more about the limitations of using SQL with Elasticsearch <a href="https://opendistro.github.io/for-elasticsearch-docs/docs/sql/">here</a>.</p>
<h1 id='microservices'>Microservices</h1>
<p>A list of information related to the microservices</p>

<aside class="notice">
    These services are only available to ADMIN users.
</aside>
<h2 id='list-all-registered-microservices'>List all registered microservices</h2>
<p>To obtain a list of all the registered microservices:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET https://api.resourcewatch.org/api/v1/microservice <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="nl">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-02-04T14:05:30.748Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"dataset"</span><span class="w">

        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://dataset.default.svc.cluster.local:3000"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/find-by-ids"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/find-by-ids"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-01-24T13:04:46.728Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="nl">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-02-04T14:05:30.778Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"layer"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"layer"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"dataset"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"layer"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5aa667d1aee7ae16fb419c23"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Layer"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://layer.default.svc.cluster.local:6000"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/layer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/layer"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-08T12:07:38.014Z"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div><h3 id='filters'>Filters</h3>
<p>The microservice list provided by the endpoint can be filtered with the following attributes:</p>

<table><thead>
<tr>
<th>Filter</th>
<th>Description</th>
<th>Accepted values</th>
</tr>
</thead><tbody>
<tr>
<td>status</td>
<td>Status of the microservice</td>
<td><code>pending</code>, <code>active</code> or <code>error</code></td>
</tr>
<tr>
<td>url</td>
<td>Internal URL of the microservice within the cluster</td>
<td>String</td>
</tr>
</tbody></table>

<blockquote>
<p>Filtering by status</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET https://api.resourcewatch.org/api/v1/microservice?status<span class="o">=</span>active <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div><h2 id='get-a-microservice-by-id'>Get a microservice by id</h2>
<p>To obtain the details of a single microservice, use:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET https://api.resourcewatch.org/api/v1/microservice/5aa667d1aee7ae16fb419c23 <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5aa667d1aee7ae16fb419c23"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="nl">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="nl">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-02-04T14:05:30.778Z"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"layer"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"layer"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"layer"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Layer"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://layer.default.svc.cluster.local:6000"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/layer"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/layer"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-08T12:07:38.014Z"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div><h2 id='delete-microservice'>Delete microservice</h2>
<p>To remove a microservice:</p>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE https://api.resourcewatch.org/api/v1/microservice/:id <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<p>This will delete the microservice and its associated endpoints from the gateway&#39;s database. It does not remove the actual running microservice application instance, which may re-register and become available once again.</p>
<h1 id='areas-v2-notification-emails'>Areas v2 Notification Emails</h1>
<p>Areas v2 services rely on email notifications to update users about the status of their areas. Specifically, when creating an area, updating an area, or when an ADMIN updates multiple areas by their geostore ids:</p>

<ul>
<li>If the area has status <code>pending</code>, an email is sent to let the user know the area of interest is being generated and will be available later.</li>
<li>If the area has status <code>saved</code>, an email is sent to let the user know the area of interest is ready to be viewed.</li>
</ul>
<h2 id='interacting-with-sparkpost-for-building-email-templates'>Interacting with Sparkpost for building email templates</h2>
<p>Emails are sent using <a href="https://www.sparkpost.com/">the Sparkpost API</a>. For the emails to be sent, there must exist templates in Sparkpost ready to be sent, taking into account the different languages supported by the Areas service:</p>

<p>For the email sent to users when the Area of Interest is ready to be viewed, there should exist the following email templates on Sparkpost:</p>

<ul>
<li><code>dashboard-complete-zh</code> (Mandarin)</li>
<li><code>dashboard-complete-pt-br</code> (Brazilian Portuguese)</li>
<li><code>dashboard-complete-id</code> (Indonesian)</li>
<li><code>dashboard-complete-fr</code> (French)</li>
<li><code>dashboard-complete-es-mx</code> (Spanish)</li>
<li><code>dashboard-complete-en</code> (English)</li>
</ul>

<p>For the email sent to users when the Area of Interest is being generated, there should exist the following email templates on Sparkpost:</p>

<ul>
<li><code>dashboard-pending-zh</code> (Mandarin)</li>
<li><code>dashboard-pending-pt-br</code> (Brazilian Portuguese)</li>
<li><code>dashboard-pending-id</code> (Indonesian)</li>
<li><code>dashboard-pending-fr</code> (French)</li>
<li><code>dashboard-pending-es-mx</code> (Spanish)</li>
<li><code>dashboard-pending-en</code> (English)</li>
</ul>

<p>In order to build your templates on Sparkpost, you need to have access to WRI&#39;s Sparkpost account - for that, please reach out to a member of WRI in order to be granted access. </p>

<p>When building the actual templates, you can use variable interpolation to customize the emails sent taking into account the area that is being processed/has been processed. While building the <code>dashboard-pending-*</code> or <code>dashboard-complete-*</code> emails, the following variables are provided and can be used in the construction of the email body:</p>

<ul>
<li><code>id</code> : the ID of the area.</li>
<li><code>name</code> : the name of the area.</li>
<li><code>location</code> : an alias for the name of the area (contains the same as the <code>name</code> parameter).</li>
<li><code>subscriptions_url</code> : the URL for managing areas of interest in the flagship application (example: <a href="https://globalforestwatch.org/my-gfw">https://globalforestwatch.org/my-gfw</a>).</li>
<li><code>dashboard_link</code> : the URL for the area dashboard (example: <a href="https://globalforestwatch.org/dashboards/aoi/:areaId">https://globalforestwatch.org/dashboards/aoi/:areaId</a>).</li>
<li><code>map_link</code> : the &quot;view on map&quot; URL for this area (example: <a href="https://globalforestwatch.org/map/aoi/:areaId">https://globalforestwatch.org/map/aoi/:areaId</a>).</li>
<li><code>image_url</code> : the URL for the image associated with the area.</li>
<li><code>tags</code> : a string containing the AOI tags, comma-separated.</li>
</ul>
<h1 id='subscriptions'>Subscriptions</h1>
<p>When communicating with the Subscriptions microservice from other microservices, you have access to special actions that are not available when using the public API. This section concerns subscriptions endpoints that offer special functionality when handling requests from other microservices.</p>
<h2 id='creating-a-subscription-for-another-user'>Creating a subscription for another user</h2>
<blockquote>
<p>Creating a subscription for user with ID 123 - only works when called by other MS!</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/subscriptions <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>  <span class="nt">-d</span> <span class="se">\</span>
 <span class="s1">'{
    "name": "&lt;name&gt;",
    "datasets": ["&lt;dataset&gt;"],
    "params": { "geostore": "35a6d982388ee5c4e141c2bceac3fb72" },
    "datasetsQuery": [
        {
            "id": ":subscription_dataset_id",
            "type": "test_subscription",
            "threshold": 1
        }
    ],
    "application": "rw",
    "language": "en",
    "env": &lt;environment&gt;,
    "resource": { "type": "EMAIL", "content": "email@address.com" },
    "userId": "123"
}'</span>
</code></pre></div>
<p>You can create a subscription for another user by providing the user id in the body of the request.</p>

<p>This can only be done when performing requests from another microservice.</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
<th style="text-align: right">Required</th>
</tr>
</thead><tbody>
<tr>
<td>userId</td>
<td style="text-align: center">Id of the owner of the subscription - if not provided, it&#39;s set as the id of the user in the token.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">No</td>
</tr>
</tbody></table>
<h2 id='updating-a-subscription-for-another-user'>Updating a subscription for another user</h2>
<p>If the request comes from another microservice, then it is possible to modify subscriptions belonging to other users. Otherwise, you can only modify subscriptions if you are the owner of the subscription.</p>

<p>The following fields are available to be provided when modifying a subscription:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
<th style="text-align: right">Required</th>
</tr>
</thead><tbody>
<tr>
<td>userId</td>
<td style="text-align: center"><a href="developer.html#updating-a-subscription-for-another-user">Check here for more info</a></td>
<td style="text-align: right">String</td>
<td style="text-align: right">No</td>
</tr>
</tbody></table>
<h2 id='finding-subscriptions-by-ids'>Finding subscriptions by ids</h2><div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/subscriptions/find-by-ids <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>  <span class="nt">-d</span> <span class="se">\</span>
 <span class="s1">'{ "ids": ["5e4d273dce77c53768bc24f9"] }'</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscription"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.176Z"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e2f0eaf9de40a6c87dd9b7d"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EMAIL"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"henrique.pacheco@vizzuality.com"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
                </span><span class="nl">"confirmed"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                </span><span class="nl">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"datasetsQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"threshold"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"lastSentDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.175Z"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"historical"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNT"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>You can find a set of subscriptions given their ids using the following endpoint.</p>
<h2 id='finding-subscriptions-for-a-given-user'>Finding subscriptions for a given user</h2><div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/subscriptions/user/5e2f0eaf9de40a6c87dd9b7d <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscription"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.176Z"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e2f0eaf9de40a6c87dd9b7d"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EMAIL"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"henrique.pacheco@vizzuality.com"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
                </span><span class="nl">"confirmed"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                </span><span class="nl">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"datasetsQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="nl">"threshold"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"lastSentDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.175Z"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"historical"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="p">,</span><span class="w">
                        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNT"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>You can find all the subscriptions associated with a given user id using the following endpoint.</p>

<p>This endpoint supports the following optional query parameters as filters:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
</tr>
</thead><tbody>
<tr>
<td>application</td>
<td style="text-align: center">Application to which the subscription is associated. Read more about the <code>application</code> field <a href="concepts.html#applications">here</a>.</td>
<td style="text-align: right">String</td>
</tr>
<tr>
<td>env</td>
<td style="text-align: center">Environment to which the subscription is associated. Read more about this field in the <a href="concepts.html#environments">Environments concept section</a>.</td>
<td style="text-align: right">String</td>
</tr>
</tbody></table>
<h2 id='finding-all-subscriptions'>Finding all subscriptions</h2><div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET https://api.resourcewatch.org/v1/subscriptions/find-all <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscription"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"57bc7f9bb67c5da7720babc3"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
                </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-10-09T06:17:54.098Z"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"userId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"57bc2631f077ce98007988f9"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EMAIL"</span><span class="p">,</span><span class="w">
                    </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"your.email@resourcewatch.org"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"umd-loss-gain"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="nl">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="nl">"geostore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d3015d189631c8e2acddda9a547260c4"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="nl">"confirmed"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="nl">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
                </span><span class="nl">"datasetsQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"self"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"total-pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"total-items"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="nl">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>You can find all the subscriptions using the following endpoint.</p>

<p>This endpoint supports the following optional query parameters as filters:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
<th style="text-align: right">Example</th>
</tr>
</thead><tbody>
<tr>
<td>application</td>
<td style="text-align: center">Application to which the subscription is associated. Read more about the <code>application</code> field <a href="concepts.html#applications">here</a>.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;rw&#39;</td>
</tr>
<tr>
<td>env</td>
<td style="text-align: center">Environment to which the subscription is associated. Read more about this field in the <a href="concepts.html#environments">Environments concept section</a>.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;production&#39;</td>
</tr>
<tr>
<td>updatedAtSince</td>
<td style="text-align: center">Filter returned subscriptions by the updatedAt date being before the date provided. Should be a valid ISO date string.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;2020-03-25T09:16:22.068Z&#39;</td>
</tr>
<tr>
<td>updatedAtUntil</td>
<td style="text-align: center">Filter returned subscriptions by the updatedAt date being after the date provided. Should be a valid ISO date string.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;2020-03-25T09:16:22.068Z&#39;</td>
</tr>
<tr>
<td>page[size]</td>
<td style="text-align: center">The number elements per page. The maximum allowed value is 100 and the default value is 10.</td>
<td style="text-align: right">Number</td>
<td style="text-align: right">10</td>
</tr>
<tr>
<td>page[number]</td>
<td style="text-align: center">The page to fetch. Defaults to 1.</td>
<td style="text-align: right">Number</td>
<td style="text-align: right">1</td>
</tr>
</tbody></table>
<h1 id='user-management'>User Management</h1>
<p>When communicating with the Authorization microservice from other microservices, you have access to additional endpoints that are not available when using the public API. This section details these endpoints.</p>
<h2 id='finding-users-by-ids'>Finding users by ids</h2><div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/auth/user/find-by-ids <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>  <span class="nt">-d</span> <span class="se">\</span>
 <span class="s1">'{ "ids": ["5e4d273dce77c53768bc24f9"] }'</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"your@email.com"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
            </span><span class="nl">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-03-24T09:19:25.000Z"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-03-26T09:54:08.000Z"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"role"</span><span class="p">:</span><span class="w"> </span><span class="s2">"USER"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"provider"</span><span class="p">:</span><span class="w"> </span><span class="s2">"local"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"extraUserData"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"apps"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"gfw"</span><span class="p">]</span><span class="w"> </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>You can find a set of users given their ids using the following endpoint. The ids of the users to find should be provided in the <code>ids</code> field of the request body.</p>

<p>Please keep in mind that, under the hood, user management relies on Okta - for this reason, this endpoint depends on Okta&#39;s user search functionalities to find users by ids, and thus, inherits Okta&#39;s limitations. Okta limits user search at a maximum of 200 users per request, so in practice, this means we can only fetch pages of 200 users at a time. If you try to find, for instance, 400 users by ids, 2 requests will need to be made to Okta to fulfill this request, and as such, the performance of this endpoint might be degraded.</p>

<p><strong>Due to these limitations, we advise only resort to this endpoint when you have no other valid alternative to find users. Even in that case, you might run into slow response times or, ultimately, not receiving the expected results when calling this endpoint.</strong></p>
<h2 id='finding-user-ids-by-role'>Finding user ids by role</h2>
<blockquote>
<p>Request structure to find user ids by role:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET https://api.resourcewatch.org/auth/user/ids/:role <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<blockquote>
<p>Example request to find user ids of ADMIN users:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> GET https://api.resourcewatch.org/auth/user/ids/ADMIN <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre></div>
<blockquote>
<p>Example response:</p>
</blockquote>
<div class="highlight"><pre class="highlight json tab-json"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="nl">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f8"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f7"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f6"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f5"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f4"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"5e4d273dce77c53768bc24f3"</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>
<p>You can find the ids of the users for a given role using the following endpoint. Valid roles include &quot;USER&quot;, &quot;MANAGER&quot; and &quot;ADMIN&quot;. The response includes the array of ids matching the role provided in the <code>data</code> field.</p>

<p>Please keep in mind that, under the hood, user management relies on Okta - for this reason, this endpoint depends on Okta&#39;s user search functionalities to find users by role, and thus, inherits Okta&#39;s limitations. Okta limits user search at a maximum of 200 users per request, so in practice, this means we can only fetch pages of 200 users at a time. If you try to find, for instance, users for the &quot;USER&quot; role, since there&#39;s a high number of &quot;USER&quot; users, many requests will have to be made to Okta to fulfill this request. As such, the performance of this endpoint might be degraded.</p>

<p><strong>Due to these limitations, we advise only resort to this endpoint when you have no other valid alternative to find users. Even in that case, you might run into slow response times or, ultimately, not receiving the expected results when calling this endpoint.</strong></p>

<p>Also, please note that existing endpoints may rely on this endpoint to be able to fulfill their requests. This is the case of sorting or filtering datasets/widgets/layers by user role, for instance. As such, the performance of these endpoints may also be affected by the degradation of performance of this endpoint. </p>
<h1 id='graph'>Graph</h1>
<p>The interaction with some of the graph endpoints is restricted to other RW API services - the following sections describe these endpoints. Keep in mind user-facing graph endpoints are described in detail in the <a href="reference.html#graph">graph endpoint documentation</a>. The <a href="concepts.html#graph">graph concept docs</a> might also be a useful resource for learning what the RW API graph is and what it has to offer you.</p>
<h2 id='creating-dataset-graph-nodes'>Creating dataset graph nodes</h2>
<blockquote>
<p>POST request to create a dataset graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/dataset/:id <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint creates a graph node for the dataset with id provided in the URL path. </p>

<p><strong>This endpoint is automatically called on dataset creation</strong>, so you don&#39;t need to manually do it yourself after you create a dataset. In order to ensure that API users cannot manually create graph nodes for datasets, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to create a graph node for a dataset, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-creating-dataset-graph-nodes'>Errors for creating dataset graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
</tbody></table>
<h2 id='creating-widget-graph-nodes'>Creating widget graph nodes</h2>
<blockquote>
<p>POST request to create a widget graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/widget/:idDataset/:idWidget <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint creates a graph node for the widget with id provided in the URL path. It also creates a graph edge, connecting the newly created widget graph node to the graph node for the dataset associated with this widget.</p>

<p><strong>This endpoint is automatically called on widget creation</strong>, so you don&#39;t need to manually do it yourself after you create a widget. In order to ensure that API users cannot manually create graph nodes for widgets, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to create a graph node for a widget, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-creating-widget-graph-nodes'>Errors for creating widget graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Dataset not found</td>
<td>No graph node for the dataset with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='creating-layer-graph-nodes'>Creating layer graph nodes</h2>
<blockquote>
<p>POST request to create a layer graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/layer/:idDataset/:idLayer <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint creates a graph node for the layer with id provided in the URL path. It also creates a graph edge, connecting the newly created layer graph node to the graph node for the dataset associated with this layer.</p>

<p><strong>This endpoint is automatically called on layer creation</strong>, so you don&#39;t need to manually do it yourself after you create a layer. In order to ensure that API users cannot manually create graph nodes for layers, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to create a graph node for a layer, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-creating-layer-graph-nodes'>Errors for creating layer graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Dataset not found</td>
<td>No graph node for the dataset with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='creating-metadata-graph-nodes'>Creating metadata graph nodes</h2>
<blockquote>
<p>POST request to create a metadata graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/metadata/:resourceType/:idResource/:idMetadata <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint creates a graph node for the metadata with id provided in the URL path. As you might have come across in the <a href="reference.html#metadata10">Metadata endpoint documentation</a>, metadata is always associated with either a dataset, layer, or widget. So, when creating a graph node for a metadata entry, you must also provide the resource type (dataset, layer, or widget) and its corresponding id. </p>

<p>Calling this endpoint will also create a graph edge connecting the newly created metadata graph node to the graph node for the resource (dataset, layer, or widget) associated with it.</p>

<p><strong>This endpoint is automatically called on metadata creation</strong>, so you don&#39;t need to manually do it yourself after you create a metadata entry. In order to ensure that API users cannot manually create graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to create a graph node for a metadata entry, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-creating-metadata-graph-nodes'>Errors for creating metadata graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Resource {:resourceType} and id ${:idResource} not found</td>
<td>No graph node for the resource with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='deleting-dataset-graph-nodes'>Deleting dataset graph nodes</h2>
<blockquote>
<p>DELETE request to remove a dataset graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE https://api.resourcewatch.org/v1/graph/dataset/:id <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint deletes the graph node for the dataset with id provided in the URL path. </p>

<p><strong>This endpoint is automatically called on dataset deletion</strong>, so you don&#39;t need to manually do it yourself after you create a dataset. In order to ensure that API users cannot manually delete graph nodes for datasets, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to delete a graph node for a dataset, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-deleting-dataset-graph-nodes'>Errors for deleting dataset graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
</tbody></table>
<h2 id='deleting-widget-graph-nodes'>Deleting widget graph nodes</h2>
<blockquote>
<p>DELETE request to remove a widget graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/widget/:id <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint deletes the graph node for the widget with id provided in the URL path.</p>

<p><strong>This endpoint is automatically called on widget deletion</strong>, so you don&#39;t need to manually do it yourself after you delete a widget. In order to ensure that API users cannot manually delete graph nodes for widgets, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to delete a graph node for a widget, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-deleting-widget-graph-nodes'>Errors for deleting widget graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
</tbody></table>
<h2 id='deleting-layer-graph-nodes'>Deleting layer graph nodes</h2>
<blockquote>
<p>DELETE request to remove a layer graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/layer/:id <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint deletes the graph node for the layer with id provided in the URL path.</p>

<p><strong>This endpoint is automatically called on layer deletion</strong>, so you don&#39;t need to manually do it yourself after you delete a layer. In order to ensure that API users cannot manually delete graph nodes for layers, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to delete a graph node for a layer, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-deleting-layer-graph-nodes'>Errors for deleting layer graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
</tbody></table>
<h2 id='deleting-metadata-graph-nodes'>Deleting metadata graph nodes</h2>
<blockquote>
<p>DELETE request to remove a metadata graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/metadata/:id <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint deletes the graph node for the metadata with id provided in the URL path.</p>

<p><strong>This endpoint is automatically called on metadata deletion</strong>, so you don&#39;t need to manually do it yourself after you delete a metadata entry. In order to ensure that API users cannot manually delete graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to delete a graph node for a metadata entry, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-deleting-metadata-graph-nodes'>Errors for deleting metadata graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
</tbody></table>
<h2 id='associating-concepts-to-graph-nodes'>Associating concepts to graph nodes</h2>
<blockquote>
<p>POST request to associate concepts to a graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/:resourceType/:idResource/associate <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
<span class="nt">-d</span> <span class="s1">'{
  "tags": ["health", "society"]
}'</span>
</code></pre></div>
<p>This endpoint creates a graph edge, representative of the relationship between the resource identified in the URL path and the concepts provided in the <code>tags</code> field of the request body.</p>

<p><strong>This endpoint is automatically called when you associate the vocabulary &quot;knowledge_graph&quot; to a resource</strong>, so you don&#39;t need to manually do it yourself. In order to ensure that API users cannot manually create graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to call this endpoint, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-associating-concepts-with-graph-nodes'>Errors for associating concepts with graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Resource {:resourceType} and id ${:idResource} not found</td>
<td>No graph node for the resource with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='updating-concepts-associated-with-graph-nodes'>Updating concepts associated with graph nodes</h2>
<blockquote>
<p>PUT request to update the concepts associated to a graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> PUT https://api.resourcewatch.org/v1/graph/:resourceType/:idResource/associate <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
<span class="nt">-d</span> <span class="s1">'{
  "tags": ["health", "society"],
  "application": "rw"
}'</span>
</code></pre></div>
<p>This endpoint updates the graph edge associated with the resource identified in the URL path. Existing concepts are deleted and replaced with the ones provided in the <code>tags</code> field of the request body.</p>

<p><strong>This endpoint is automatically called when you associate the vocabulary &quot;knowledge_graph&quot; to a resource</strong>, so you don&#39;t need to manually do it yourself. In order to ensure that API users cannot manually create graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to call this endpoint, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-associating-concepts-with-graph-nodes-2'>Errors for associating concepts with graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Resource {:resourceType} and id ${:idResource} not found</td>
<td>No graph node for the resource with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='deleting-concepts-associated-with-graph-nodes'>Deleting concepts associated with graph nodes</h2>
<blockquote>
<p>DELETE request to remove concepts associated to a graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE https://api.resourcewatch.org/v1/graph/:resourceType/:idResource/associate <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint deletes the graph edge associated with the resource identified in the URL path.</p>

<p><strong>This endpoint is automatically called when you associate the vocabulary &quot;knowledge_graph&quot; to a resource</strong>, so you don&#39;t need to manually do it yourself. In order to ensure that API users cannot manually create graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to call this endpoint, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='query-parameters'>Query parameters</h3>
<blockquote>
<p>Specifying the application of the resource to be deleted:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE https://api.resourcewatch.org/v1/graph/:resourceType/:idResource/associate?application<span class="o">=</span>gfw
</code></pre></div>
<p>You can use the query parameter <code>application</code> to specify the application of the graph edge to be deleted by this request. You can find out more information about this field <a href="concepts.html#applications">here</a>.</p>
<h3 id='errors-for-associating-concepts-with-graph-nodes-3'>Errors for associating concepts with graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Resource {:resourceType} and id ${:idResource} not found</td>
<td>No graph node for the resource with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='creating-favorite-relationships-between-users-and-graph-nodes'>Creating favorite relationships between users and graph nodes</h2>
<blockquote>
<p>POST request to create favorite relationship between user and graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> POST https://api.resourcewatch.org/v1/graph/favourite/:resourceType/:idResource/:userId <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="se">\</span>
<span class="nt">-d</span> <span class="s1">'{ "application": "rw" }'</span>
</code></pre></div>
<p>This endpoint creates a graph edge representative of a favorite relationship between the resource identified in the URL path and the user id also identified in the URL path.</p>

<p><strong>This endpoint is automatically called when you call vocabulary&#39;s create favorite endpoint</strong>, so you don&#39;t need to manually do it yourself. In order to ensure that API users cannot manually create graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to call this endpoint, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='errors-for-associating-concepts-with-graph-nodes-4'>Errors for associating concepts with graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Resource {:resourceType} and id ${:idResource} not found</td>
<td>No graph node for the resource with id provided was found.</td>
</tr>
</tbody></table>
<h2 id='deleting-favorite-relationships-between-users-and-graph-nodes'>Deleting favorite relationships between users and graph nodes</h2>
<blockquote>
<p>DELETE request to remove favorite relationship between user and graph node:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE https://api.resourcewatch.org/v1/graph/favourite/:resourceType/:idResource/:userId <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
<span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span>
</code></pre></div>
<p>This endpoint deletes the graph edge representative of a favorite relationship between the resource identified in the URL path and the user id also identified in the URL path.</p>

<p><strong>This endpoint is automatically called when you call vocabulary&#39;s delete favorite endpoint</strong>, so you don&#39;t need to manually do it yourself. In order to ensure that API users cannot manually create graph nodes for metadata entries, this endpoint requires authentication from a RW API service, meaning that normal API users won&#39;t be able to call this endpoint successfully. If, as an API user and using your user&#39;s token, you try to call this endpoint, you will receive a response with HTTP status code <code>403 Forbidden</code>.</p>
<h3 id='query-parameters-2'>Query parameters</h3>
<blockquote>
<p>Specifying the application of the favorite relationship to be deleted:</p>
</blockquote>
<div class="highlight"><pre class="highlight shell tab-shell"><code>curl <span class="nt">-X</span> DELETE https://api.resourcewatch.org/v1/graph/favourite/:resourceType/:idResource/:userId?application<span class="o">=</span>gfw
</code></pre></div>
<p>You can use the query parameter <code>application</code> to specify the application of the graph edge to be deleted by this request. You can find out more information about this field <a href="concepts.html#applications">here</a>.</p>
<h3 id='errors-for-associating-concepts-with-graph-nodes-5'>Errors for associating concepts with graph nodes</h3>
<table><thead>
<tr>
<th>Error code</th>
<th>Error message</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>401</td>
<td>Unauthorized</td>
<td>No authorization token provided.</td>
</tr>
<tr>
<td>403</td>
<td>Not authorized</td>
<td>You are trying to call this endpoint without being identified as a RW API service.</td>
</tr>
<tr>
<td>404</td>
<td>Resource {:resourceType} and id ${:idResource} not found</td>
<td>No graph node for the resource with id provided was found.</td>
</tr>
</tbody></table>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">cURL</a>
          </div>
      </div>
    </div>
  </body>
</html>
